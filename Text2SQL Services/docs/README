# Chatbot Text-to-SQL (Gemini + SQLCoder)

Ứng dụng web giúp chuyển câu hỏi ngôn ngữ tự nhiên thành **SQL**.  
Hỗ trợ upload 1 hoặc nhiều **schema**; sinh câu truy vấn bằng **SQLCoder-7B-2** (rẻ/nhanh) và **Gemini** (refine/fallback); thực thi SQL trên ClickHouse (nếu cấu hình) và “ghi nhớ” truy vấn đã duyệt.

## ⭐ Tính năng chính

- **Upload nhiều schema trong *một lần*** → hệ thống:
  - Lưu tạm từng file + metadata trong `./sample/uploading/`
  - **Gộp** lại thành 1 “bundle” trong `./sample/uploaded/` rồi **xóa** thư mục tạm
  - Từ đây, mọi chat chỉ dùng **bundle** mới nhất
- **Hỏi → Xác nhận** → *Generate SQL* → *Result* → **Lưu/Bỏ qua/Refine**
- **Kết quả SQL** hiển thị kèm:
  - `Nguồn: SQLCoder-7B-2`, `Gemini`, hoặc `SQLCoder-7B-2 → Gemini (refine)`
  - `Result:` (nếu có DB) hoặc `null`
- **Memory**:
  - Upload **1 schema** → lưu vào `./knowledge_base/memory/memory_<table>.txt`
  - Upload **nhiều schema** → lưu **gộp** vào `./knowledge_base/memory/memories_<IDs>.txt`
    - `<IDs>` là chuỗi 2 chữ số theo thứ tự upload, ví dụ: `01+02`
    - Tin nhắn phản hồi có kèm **mapping**: `01=auto_pickup_ticket, 02=staff`
- **Refine**: nhập “lý do chưa đúng” + “chi tiết bổ sung” để tạo lại SQL
- **Check UI**: 
  - `Xóa chat` (clear ngay)
  - `Tự đóng yêu cầu` (đóng các thẻ Confirm/Approve/Refine sau khi chọn)
  - `Xem schema`: hiện danh sách file, bảng, mapping ID, tên bundle/memories

## Kiến trúc & luồng

1. **Upload schema** (`POST /upload-schema`):
   - Nhận 1..n file (`.txt/.sql/.csv/.json/.jsonl`)
   - Lưu bản sao + meta vào `sample/uploading/`
   - Ghép thành `sample/uploaded/bundle_<IDs or table>.txt`
   - Xóa `sample/uploading/*`
   - `SCHEMA_FILES` trỏ **bundle** để chat chỉ nhìn bộ mới
2. **Chat** (`POST /chat`):
   - Tìm trong dataset (base + memory của **bộ active hiện tại**)
   - Nếu không có → hỏi xác nhận
   - Nếu đồng ý:
     - **Hybrid**:
       - `HYBRID_STRATEGY=cascade` → thử **SQLCoder** trước → nếu chưa ổn → **Gemini refine**
       - `sqlcoder_only` → chỉ SQLCoder
       - `gemini_only` → chỉ Gemini
     - Trả `SQL + Result + Nguồn + needs_check=true`
3. **Lưu** (`POST /check`):
   - 1 schema → `memory_<table>.txt`
   - N schema → `memories_<IDs>.txt` (kèm mapping)
4. **Refine** (`POST /refine`):
   - Dựa trên feedback/extra notes → Gemini sửa SQL → trả lại như bước 2

## Cấu trúc thư mục

project/
├─ app.py # Flask backend (chạy trực tiếp: python app.py)
├─ templates/
│ └─ index.html # UI (Tailwind CDN)
├─ uploads/ # file upload gốc (tự tạo)
├─ sample/
│ ├─ uploading/ # bản sao + meta tạm thời (bị xóa sau khi gộp)
│ └─ uploaded/
│ ├─ bundle_01+02.txt # bundle schema đang active
│ └─ bundle_01+02.meta.json
├─ knowledge_base/
│ └─ memory/
│ ├─ memory_<table>.txt
│ └─ memories_01+02.txt
├─ data/
│ ├─ dataset_base.jsonl # optional: dữ liệu seed Q&A
│ └─ eval.jsonl # optional: evaluate
├─ .env # cấu hình runtime (KHÔNG commit)
└─ requirements.txt

Cấu hình .env
# --- LLM strategy ---
HYBRID_STRATEGY=cascade          # cascade | sqlcoder_only | gemini_only
SQLCODER_REQUIRE_KNOWN_TABLE=1   # 1: SQL phải chứa tên bảng đã biết; 0: nới lỏng

# --- SQLCoder backend (chọn 1) ---
SQLCODER_BACKEND=hf              # hf | ollama | vllm
SQLCODER_MODEL=defog/sqlcoder-7b-2

# HuggingFace Inference API
HF_API_TOKEN=...

# vLLM (OpenAI-compatible server)
# VLLM_BASE_URL=http://localhost:8000/v1
# VLLM_MODEL=defog/sqlcoder-7b-2

# Ollama (local)
# OLLAMA_HOST=http://localhost:11434

# --- Gemini ---
GEMINI_API_KEY=...

# --- ClickHouse (tuỳ chọn; để thực thi SQL thật) ---
CLICKHOUSE_HOST=localhost
CLICKHOUSE_PORT=8123
CLICKHOUSE_USER=default
CLICKHOUSE_PASSWORD=
CLICKHOUSE_DB=default

Chạy
python app.py
# mở http://localhost:5000


Cách dùng nhanh

Upload 1..n file schema → status hiển thị “Đã upload”

(Chọn Xem schema) để thấy Files / Tables / Mapping / Bundle

Gõ câu hỏi → nếu chưa có trong dataset, bot sẽ hỏi Có tạo SQL không?

Chọn Có → xem SQL được tạo + Result + Nguồn

Lưu (để ghi vào memory) hoặc Tạo lại (nhập feedback/chi tiết để refine)

Nếu chưa cấu hình DB ClickHouse, Result sẽ là null (điều này bình thường).

Endpoint (dành cho tích hợp)

POST /upload-schema : upload 1..n file (field name: file)

GET /schema : xem bundle/tables/mapping/schema_text

POST /chat : { "message": "..." } → xem needs_confirmation / needs_check

POST /check : { question, sql, approve: true|false }

POST /refine : { question, sql, feedback, extra_context }

GET /evaluate : tính EM accuracy trên data/eval.jsonl

Troubleshooting

Nguồn hiển thị “Gemini” dù đã bật SQLCoder:

Đặt HYBRID_STRATEGY=sqlcoder_only để ép chỉ dùng SQLCoder

Hoặc SQLCODER_REQUIRE_KNOWN_TABLE=0 để bớt khắt khe khi kiểm tra hợp lệ

Result = null: chưa cấu hình ClickHouse hoặc query trả 0 dòng

Không lưu được memory:

Kiểm tra upload 1 hay nhiều schema:

1 schema → file memory_<table>.txt

N schema → file memories_<IDs>.txt (kèm mapping)

