<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ChatBot Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                        accent: '#f093fb',
                        dark: {
                            bg: '#1a1a2e',
                            surface: '#16213e',
                            card: '#0f3460',
                            text: '#e4e4e7',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                        'pulse-soft': 'pulseSoft 2s infinite',
                        'bounce-soft': 'bounceSoft 1s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.7' },
                        },
                        bounceSoft: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Tailwind Enhancements -->
    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                @apply bg-white/10 backdrop-blur-lg border border-white/20;
            }
            .glass-dark {
                @apply bg-black/20 backdrop-blur-lg border border-white/10;
            }
            .gradient-primary {
                @apply bg-gradient-to-r from-primary to-secondary;
            }
            .gradient-accent {
                @apply bg-gradient-to-r from-primary via-accent to-secondary;
            }
            .text-gradient {
                @apply bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary;
            }
            .shadow-glow {
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            }
            .shadow-glow-sm {
                box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 6px;
            }
            .scrollbar-thin::-webkit-scrollbar-track {
                @apply bg-gray-100 dark:bg-gray-800 rounded;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                @apply bg-gray-300 dark:bg-gray-600 rounded hover:bg-gray-400 dark:hover:bg-gray-500;
            }
            .btn-primary {
                @apply px-4 py-2 rounded-lg gradient-primary text-white font-medium 
                       transition-all duration-200 hover:shadow-glow hover:scale-105 
                       active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed;
            }
            .btn-secondary {
                @apply px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 
                       text-gray-700 dark:text-gray-200 font-medium
                       transition-all duration-200 hover:bg-gray-300 dark:hover:bg-gray-600
                       active:scale-95;
            }
            .card {
                @apply bg-white dark:bg-dark-surface rounded-xl shadow-lg 
                       border border-gray-100 dark:border-gray-700 
                       transition-all duration-200;
            }
            .card-hover {
                @apply hover:shadow-xl hover:scale-[1.02] hover:border-primary/30;
            }
            .input-field {
                @apply w-full px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-600
                       bg-white dark:bg-dark-surface text-gray-800 dark:text-gray-200
                       focus:ring-2 focus:ring-primary/50 focus:border-primary
                       transition-all duration-200 outline-none;
            }
            .modal-overlay {
                @apply fixed inset-0 bg-black/50 backdrop-blur-sm z-50 
                       items-center justify-center;
                display: none; /* Hidden by default, shown via JS */
            }
            .modal-overlay.active {
                display: flex;
                animation: fadeIn 0.3s ease-out;
            }
            .modal-content {
                @apply bg-white dark:bg-dark-surface rounded-2xl shadow-2xl 
                       max-w-2xl w-full mx-4 max-h-[90vh] overflow-auto
                       animate-slide-up;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark-bg transition-colors duration-300">
    <!-- Sidebar Toggle (Mobile) -->
    <div class="sidebar-toggle fixed top-4 left-4 z-50 md:hidden bg-primary text-white p-2 rounded-lg shadow-lg hover:shadow-glow transition-all duration-200" id="sidebarToggle">
        ☰
    </div>
    
    <div class="main-wrapper">
        <!-- Sidebar -->
        <div class="sidebar scrollbar-thin" id="sidebar">
            <div class="sidebar-header">
                <h3 class="text-lg font-semibold" data-lang-key="sidebar.title">💬 Lịch sử Chat</h3>
                <button class="new-chat-btn btn-primary text-sm" id="newChatBtn" data-lang-key="sidebar.newChat">+ Mới</button>
            </div>
            <div class="px-3 py-2 text-xs text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700">
                <span id="storageInfo" data-lang-key="sidebar.calculating">Đang tính...</span>
            </div>
            <div class="chat-list scrollbar-thin" id="chatList">
                <!-- Chat items will be dynamically added here -->
            </div>
            <div class="sidebar-footer p-3">
                <button class="gallery-btn w-full btn-secondary flex items-center justify-center gap-2" id="galleryBtn" title="Xem ảnh đã tạo">
                    🖼️ Gallery ảnh
                </button>
            </div>
        </div>
        
        <!-- Main Chat Container -->
        <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="text-align: center; flex: 1;">
                    <h1 style="position: relative;" data-lang-key="app.title">🤖 AI ChatBot Assistant</h1>
                    <p data-lang-key="app.subtitle">Hỗ trợ tâm lý, tâm sự và giải pháp đời sống, hỗ trợ lập trình chung</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <a href="https://github.com/SkastVnT/AI-Assistant" target="_blank" rel="noopener noreferrer" class="github-badge">
                        <svg height="24" width="24" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                        <span>@SkastVnT</span>
                    </a>
                    <button class="lang-toggle-btn" id="langBtn" title="Switch to English">🇬🇧 EN</button>
                </div>
            </div>
        </div>
        
        <div class="controls glass-dark backdrop-blur-md border-b border-gray-200/20 dark:border-gray-700/50">
            <div class="control-group flex flex-wrap items-center gap-3 p-3"> 
                <label class="flex items-center gap-2 text-sm">
                    <span data-lang-key="controls.model" class="text-gray-600 dark:text-gray-300 font-medium">Model:</span>
                    <select id="modelSelect" class="input-field bg-white/90 dark:bg-dark-surface/90 rounded-lg px-3 py-2 text-sm border border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-primary/50 transition-all duration-200">
                        <option value="grok" data-lang-key="model.grok">GROK (xAI) - FREE ⭐</option>
                        <option value="openai" data-lang-key="model.openai">GPT-4o-mini (OpenAI)</option>
                        <option value="deepseek" data-lang-key="model.deepseek">DeepSeek (Rẻ nhất)</option>
                        <option value="qwen" data-lang-key="model.qwen">Qwen1.5b (Alibaba Cloud)</option>
                        <option value="bloomvn" data-lang-key="model.bloomvn">BloomVN-8B API (Tiếng Việt) - FREE</option>
                        <optgroup label="🖥️ Local Models (FREE - No Internet)" data-lang-key="model.local.group">
                            <option value="qwen1.5-local" data-lang-key="model.local.qwen15">🖥️ Qwen1.5-1.8B Local</option>
                            <option value="bloomvn-local" data-lang-key="model.local.bloomvn">🖥️ BloomVN-8B Local</option>
                            <option value="qwen2.5-local" data-lang-key="model.local.qwen25">🖥️ Qwen2.5-14B Local ⭐</option>
                        </optgroup>
                    </select>
                </label>
                
                <label class="flex items-center gap-2 text-sm">
                    <span data-lang-key="controls.mode" class="text-gray-600 dark:text-gray-300 font-medium">Chế độ:</span>
                    <select id="contextSelect" class="input-field bg-white/90 dark:bg-dark-surface/90 rounded-lg px-3 py-2 text-sm border border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-primary/50 transition-all duration-200">
                        <option value="casual" data-lang-key="controls.mode.casual">Trò chuyện vui vẻ</option>
                        <option value="psychological" data-lang-key="controls.mode.psychological">Tâm lý - Tâm sự</option>
                        <option value="lifestyle" data-lang-key="controls.mode.lifestyle">Giải pháp đời sống</option>
                        <option value="programming" data-lang-key="controls.mode.programming">💻 Hỗ trợ lập trình</option>
                    </select>
                </label>
                
                <div class="checkbox-container flex items-center gap-2 bg-white/50 dark:bg-dark-surface/50 px-3 py-2 rounded-lg" id="deepThinkingContainer">
                    <input type="checkbox" id="deepThinkingCheck" class="w-4 h-4 text-primary rounded focus:ring-primary/50">
                    <label for="deepThinkingCheck" data-lang-key="controls.deepThinking" class="text-sm cursor-pointer">🧠 Suy luận sâu</label>
                </div>
                
                <button class="download-btn btn-secondary hover:shadow-glow-sm" id="downloadBtn" title="Tải xuống lịch sử chat" data-lang-key="controls.download" data-lang-key-title="tooltip.download">
                    📥 Tải chat
                </button>
                <button class="image-gen-btn btn-primary hover:shadow-glow" id="imageGenBtn" title="Tạo ảnh bằng AI" data-lang-key="controls.imageGen" data-lang-key-title="tooltip.imageGen">
                    🎨 Tạo ảnh
                </button>
                <button class="memory-btn btn-secondary hover:shadow-glow-sm" id="memoryBtn" title="Quản lý bộ nhớ AI" data-lang-key="controls.memory" data-lang-key-title="tooltip.memory">
                    🧠 AI học tập
                </button>
                <button class="dark-mode-toggle btn-secondary" id="darkModeBtn" title="Toggle Dark Mode" data-lang-key-title="tooltip.darkMode">🌙</button>
                <button id="clearBtn" data-lang-key="controls.clear" class="btn-secondary hover:bg-red-500 hover:text-white hover:border-red-500 transition-all duration-200">🗑️ Xóa lịch sử</button>
            </div>
        </div>
        
        <!-- Main Content Area with Chat and MCP File Browser -->
        <div class="content-wrapper">
            <!-- Chat Container (Left) -->
            <div class="chat-section">
                <div class="chat-container" id="chatContainer">
                    <div class="message assistant">
                        <div class="message-content">
                            <div data-lang-key="chat.welcome">Xin chào! Tôi là trợ lý AI của bạn. Tôi có thể giúp gì cho bạn hôm nay? 😊</div>
                            <div class="message-info">GROK • <span data-lang-key="controls.mode.casual">Trò chuyện vui vẻ</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Memory Panel (hidden by default) -->
                <div class="memory-panel" id="memoryPanel" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong data-lang-key="memory.title">📚 Bài học đã lưu (chọn để kích hoạt):</strong>
                        <button class="new-chat-btn" id="saveMemoryBtn" style="padding: 5px 12px; font-size: 12px;" data-lang-key="memory.save">
                            💾 Lưu chat này
                        </button>
                    </div>
                    <div id="memoryList">
                        <!-- Memory items will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- MCP Toggle Button (Always Visible) -->
            <button class="mcp-toggle-btn" id="mcpToggleBtn" title="Mở rộng MCP">
                ▶
            </button>
            
            <!-- MCP File Browser Sidebar (Right) -->
            <div class="mcp-sidebar" id="mcpSidebar">
                <div class="mcp-sidebar-header">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <input type="checkbox" id="mcpEnabledCheck">
                        <label for="mcpEnabledCheck" style="margin: 0; font-weight: 600;">
                            🔗 <span data-lang-key="mcp.enable">MCP File Browser</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button class="mcp-btn" id="mcpSelectFolderBtn" disabled>
                            📁 <span data-lang-key="mcp.selectFolder">Chọn folder</span>
                        </button>
                        <span id="mcpStatus" class="mcp-status-badge">
                            <span data-lang-key="mcp.status.disabled">⚪ Tắt</span>
                        </span>
                    </div>
                    <div id="mcpFolderList" class="mcp-folder-tags" style="display: none;">
                        <!-- Selected folders will appear here -->
                    </div>
                </div>
                
                <div class="mcp-file-browser" id="mcpFileBrowser">
                    <div class="mcp-search-box">
                        <input type="text" id="mcpFileSearch" placeholder="🔍 Tìm file..." disabled>
                    </div>
                    <div class="mcp-file-list" id="mcpFileList">
                        <div class="mcp-empty-state">
                            <p>📂 Chưa chọn folder</p>
                            <p style="font-size: 11px; color: #888;">Bật MCP và chọn folder để xem files</p>
                        </div>
                    </div>
                </div>
                
                <div class="mcp-selected-files" id="mcpSelectedFiles" style="display: none;">
                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #667eea;">
                        📌 Files đã chọn (<span id="selectedFileCount">0</span>)
                    </div>
                    <div id="selectedFileList"></div>
                </div>
            </div>
        </div>
        
        <div class="loading animate-fade-in" id="loading">
            <div class="spinner"></div>
            <span id="loadingText" data-lang-key="loading.thinking" class="text-gray-600 dark:text-gray-300">Đang suy nghĩ...</span>
            <button class="stop-generation-btn btn-secondary hover:bg-red-500 hover:text-white hover:border-red-500 transition-all duration-200" id="stopGenerationBtn" data-lang-key="loading.stop">⏹️ Dừng lại</button>
        </div>
        
        <div class="input-container glass-dark backdrop-blur-md border-t border-gray-200/20 dark:border-gray-700/50">
            <div class="input-tools flex flex-wrap gap-2 mb-3">
                <button class="tool-btn btn-secondary text-sm px-3 py-1.5 rounded-lg hover:shadow-glow-sm transition-all duration-200" id="customPromptBtn" title="Tùy chỉnh System Prompt" data-lang-key="tools.customPrompt" data-lang-key-title="tooltip.customPrompt">
                    🛠️ Custom Prompt
                </button>
                <button class="tool-btn btn-secondary text-sm px-3 py-1.5 rounded-lg hover:shadow-glow-sm transition-all duration-200" id="googleSearchBtn" title="Tìm kiếm Google" data-lang-key="tools.googleSearch" data-lang-key-title="tooltip.googleSearch">
                    🔍 Google Search
                </button>
                <button class="tool-btn btn-secondary text-sm px-3 py-1.5 rounded-lg hover:shadow-glow-sm transition-all duration-200" id="githubBtn" title="Kết nối GitHub" data-lang-key-title="tooltip.github">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    <span data-lang-key="tools.github">GitHub</span>
                </button>
                <button class="tool-btn btn-secondary text-sm px-3 py-1.5 rounded-lg hover:shadow-glow-sm transition-all duration-200" id="imageGenToolBtn" title="Tạo ảnh từ text prompt (Text2Img)" data-lang-key="tools.text2img" data-lang-key-title="tooltip.text2img">
                    🎨 Text2Img
                </button>
                <button class="tool-btn btn-secondary text-sm px-3 py-1.5 rounded-lg hover:shadow-glow-sm transition-all duration-200" id="img2imgToolBtn" title="Tạo ảnh từ upload (Img2Img)" data-lang-key="tools.img2img" data-lang-key-title="tooltip.img2img">
                    🖼️ Img2Img
                </button>
                <button class="tool-btn btn-secondary text-sm px-3 py-1.5 rounded-lg hover:shadow-glow-sm transition-all duration-200" id="uploadFilesBtn" title="Upload tài liệu (txt, pdf, doc, code files)" data-lang-key="tools.uploadFiles" data-lang-key-title="tooltip.uploadFiles">
                    📎 Upload Files
                </button>
                <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.json,.py,.js,.html,.css,.xlsx,.csv,image/*" multiple style="display: none;">
            </div>
            <div class="file-list" id="fileList">
                <!-- Uploaded files will appear here -->
            </div>
            <div class="input-group flex gap-3 items-end">
                <textarea 
                    id="messageInput" 
                    placeholder="Nhập tin nhắn của bạn... (Shift+Enter để xuống dòng, Ctrl+V để paste)"
                    data-lang-key="input.placeholder"
                    rows="1"
                    class="flex-1 input-field resize-none rounded-xl px-4 py-3 text-base border-2 border-gray-200 dark:border-gray-600 focus:border-primary focus:ring-4 focus:ring-primary/20 transition-all duration-200 scrollbar-thin"
                ></textarea>
                <button id="sendBtn" data-lang-key="input.send" class="btn-primary px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-glow transition-all duration-200 transform hover:scale-105 active:scale-95">Gửi</button>
            </div>
        </div>
        </div> <!-- Close container -->
    </div> <!-- Close main-wrapper -->
    
    <!-- Image Generation Modal -->
    <div id="imageGenModal" class="modal">
        <div class="modal-content animate-slide-up glass-dark backdrop-blur-xl rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto scrollbar-thin">
            <div class="modal-header flex justify-between items-center p-5 border-b border-gray-200/20 dark:border-gray-700/50">
                <h2 data-lang-key="imageGen.title" class="text-xl font-bold text-gradient">🎨 Tạo ảnh bằng AI</h2>
                <button class="close-modal btn-secondary w-10 h-10 rounded-full flex items-center justify-center text-xl hover:bg-red-500 hover:text-white hover:border-red-500 transition-all duration-200" onclick="closeImageModal()">&times;</button>
            </div>
            
            <div id="sdStatus" class="sd-status offline mx-5 mt-4 px-4 py-2 rounded-lg text-sm font-medium" data-lang-key="imageGen.status.checking">
                Đang kiểm tra Stable Diffusion...
            </div>

            <!-- Tab Navigation -->
            <div class="image-gen-tabs flex gap-2 p-4">
                <button class="tab-btn active btn-primary px-4 py-2 rounded-lg font-medium transition-all duration-200" onclick="switchImageGenTab('text2img')" data-lang-key="imageGen.tab.text2img">
                    ✍️ Tạo ảnh từ prompt
                </button>
                <button class="tab-btn btn-secondary px-4 py-2 rounded-lg font-medium transition-all duration-200" onclick="switchImageGenTab('img2img')" data-lang-key="imageGen.tab.img2img">
                    🖼️ Tạo ảnh theo hình ảnh
                </button>
            </div>

            <!-- Shared Model Selection -->
            <div class="form-group px-5 py-3">
                <label data-lang-key="imageGen.model" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Model Checkpoint:</label>
                <select id="modelCheckpoint" class="input-field w-full rounded-lg px-4 py-2 border border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-primary/50 transition-all duration-200">
                    <option value="" data-lang-key="imageGen.model.loading">Đang tải...</option>
                </select>
            </div>

            <!-- Text2Img Tab Content -->
            <div id="text2imgTab" class="tab-content active">
            
            <div class="form-group">
                <label data-lang-key="imageGen.prompt">Prompt (Mô tả ảnh bạn muốn tạo):</label>
                <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                    <button onclick="randomPrompt()" style="padding: 5px 15px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" data-lang-key="imageGen.random">🎲 Random</button>
                </div>
                <textarea id="imagePrompt" rows="4" placeholder="1girl, beautiful, detailed face, long hair, cherry blossoms, sunset, masterpiece, best quality" data-lang-key="imageGen.prompt.placeholder"></textarea>
            </div>
            
            <div class="form-group">
                <label data-lang-key="imageGen.negativePrompt">Negative Prompt (Những gì KHÔNG muốn có):</label>
                <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                    <button onclick="randomNegativePrompt()" style="padding: 5px 15px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" data-lang-key="imageGen.random">🎲 Random</button>
                </div>
                <textarea id="negativePrompt" rows="3" placeholder="bad quality, blurry, distorted, ugly, worst quality" data-lang-key="imageGen.negativePrompt.placeholder"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label data-lang-key="imageGen.width">Width:</label>
                    <select id="imageWidth">
                        <option value="512" selected>512 (Safe)</option>
                        <option value="768">768</option>
                        <option value="1024">1024</option>
                        <option value="1280">1280</option>
                        <option value="1440">1440 (HD)</option>
                        <option value="1920">1920 (FHD)</option>
                        <option value="2560">2560 (4K HD)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label data-lang-key="imageGen.height">Height:</label>
                    <select id="imageHeight">
                        <option value="512" selected>512 (Safe)</option>
                        <option value="768">768</option>
                        <option value="1024">1024</option>
                        <option value="1280">1280</option>
                        <option value="1440">1440 (HD)</option>
                        <option value="1920">1920 (FHD)</option>
                        <option value="2560">2560 (4K HD)</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label><span data-lang-key="imageGen.steps">Steps</span> <span id="stepsLabel" data-lang-key="imageGen.stepsHint">(20-50 khuyến nghị)</span>:</label>
                    <input type="number" id="imageSteps" value="20" min="1" max="150">
                </div>
                
                <div class="form-group">
                    <label><span data-lang-key="imageGen.cfgScale">CFG Scale</span> <span id="cfgLabel" data-lang-key="imageGen.cfgHint">(7-12 khuyến nghị)</span>:</label>
                    <input type="number" id="cfgScale" value="7" min="1" max="30" step="0.5">
                </div>
            </div>
            
            <div class="form-group">
                <label data-lang-key="imageGen.sampler">Sampler:</label>
                <select id="samplerSelect">
                    <option value="DPM++ 2M Karras" selected>DPM++ 2M Karras</option>
                    <option value="Euler a">Euler a</option>
                    <option value="Euler">Euler</option>
                    <option value="DDIM">DDIM</option>
                    <option value="DPM++ SDE Karras">DPM++ SDE Karras</option>
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="restoreFaces">
                        <span data-lang-key="imageGen.restoreFaces">Restore Faces (GFPGAN)</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableHR">
                        <span data-lang-key="imageGen.hiresfix">Hires. Fix (Chất lượng cao)</span>
                    </label>
                </div>
            </div>
            
            <!-- Lora Selection Section -->
            <div class="form-group" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <label style="font-weight: 600;" data-lang-key="imageGen.lora">🎨 Lora Models (Tùy chọn):</label>
                <div id="loraSelectionContainer" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                    <button type="button" id="addLoraBtn" class="secondary-btn" onclick="addLoraSelection()" data-lang-key="imageGen.addLora">
                        ➕ Thêm Lora
                    </button>
                </div>
            </div>
            
            <!-- VAE Selection -->
            <div class="form-group">
                <label>🔧 VAE Model:</label>
                <select id="vaeSelect">
                    <option value="">Automatic (Mặc định)</option>
                </select>
            </div>
            
            <button class="generate-btn btn-primary w-full py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-glow transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98]" id="generateImageBtn" onclick="generateImage()">
                🎨 Tạo ảnh
            </button>

            </div>
            <!-- End Text2Img Tab -->

            <!-- Img2Img Tab Content -->
            <div id="img2imgTab" class="tab-content" style="display: none;">
                
                <!-- Upload Image Section -->
                <div class="form-group">
                    <label>📤 Upload hình ảnh gốc (Bắt buộc):</label>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('sourceImage').click()">
                        <div id="uploadPlaceholder">
                            <span style="font-size: 48px;">📷</span>
                            <p>Click để chọn ảnh hoặc kéo thả vào đây</p>
                            <p style="font-size: 12px; color: #999;">Hỗ trợ: JPG, PNG, WebP</p>
                        </div>
                        <img id="sourceImagePreview" style="display: none; max-width: 100%; max-height: 300px; border-radius: 8px;">
                    </div>
                    <input type="file" id="sourceImage" accept="image/*" style="display: none;" onchange="handleSourceImageUpload(event)">
                </div>

                <!-- Extract Features Section -->
                <div id="featureExtractionSection" style="display: none;">
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <label style="font-weight: 600; font-size: 15px;">🔍 Trích xuất đặc trưng</label>
                            <span style="font-size: 12px; color: #888;">Sử dụng DeepDanbooru 🎨</span>
                        </div>
                        
                        <button class="extract-btn" onclick="extractFeatures()" style="width: 100%; padding: 12px; margin-bottom: 15px; background: linear-gradient(135deg, #ff9800, #ff5722); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s;">
                            🔬 Trích xuất đặc trưng
                        </button>
                        
                        <div id="extractedTags" style="display: none;">
                            <div style="margin-bottom: 10px; padding: 10px; background: rgba(103, 126, 234, 0.1); border-left: 3px solid #667eea; border-radius: 4px; font-size: 13px;">
                                💡 <strong>Tip:</strong> Click vào tag để loại bỏ khỏi prompt
                            </div>
                            <div id="tagsList" style="max-height: 400px; overflow-y: auto; border-radius: 8px;">
                                <!-- Tags will be populated here by category -->
                            </div>
                            
                            <!-- Auto-generate Prompt Button -->
                            <div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px;">
                                <button 
                                    id="autoGeneratePromptBtn" 
                                    onclick="autoGeneratePromptFromTags()" 
                                    style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: none;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    🤖 Tạo prompt tự động từ đặc trưng (GROK AI)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prompt Section for Img2Img -->
                <div class="form-group">
                    <label>Prompt tạo ảnh:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                        <button onclick="randomImg2ImgPrompt()" style="padding: 5px 15px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🎲 Random</button>
                        <span style="font-size: 11px; color: #888; align-self: center;">💡 Có thể để trống, nhấn nút Auto-generate bên trên</span>
                    </div>
                    <textarea id="img2imgPrompt" rows="3" placeholder="Nhập prompt hoặc sử dụng Auto-generate từ đặc trưng..."></textarea>
                </div>

                <div class="form-group">
                    <label>Negative Prompt:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                        <button onclick="randomImg2ImgNegativePrompt()" style="padding: 5px 15px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🎲 Random</button>
                    </div>
                    <textarea id="img2imgNegativePrompt" rows="2" placeholder="bad quality, blurry, distorted"></textarea>
                </div>

                <!-- Image Size for Img2Img -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Width:</label>
                        <select id="img2imgWidth">
                            <option value="512">512</option>
                            <option value="768" selected>768</option>
                            <option value="1024">1024</option>
                            <option value="1280">1280</option>
                            <option value="1440">1440 (HD)</option>
                            <option value="1920">1920 (FHD)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Height:</label>
                        <select id="img2imgHeight">
                            <option value="512">512</option>
                            <option value="768" selected>768</option>
                            <option value="1024">1024</option>
                            <option value="1280">1280</option>
                            <option value="1440">1440 (HD)</option>
                            <option value="1920">1920 (FHD)</option>
                        </select>
                    </div>
                </div>

                <!-- Generation Settings for Img2Img -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Denoising Strength:</label>
                        <input type="number" id="denoisingStrength" value="0.6" min="0" max="1" step="0.05">
                    </div>
                    
                    <div class="form-group">
                        <label>Feature Weight (%):</label>
                        <input type="number" id="featureWeight" value="80" min="0" max="100" step="5">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Steps:</label>
                        <input type="number" id="img2imgSteps" value="30" min="1" max="150">
                    </div>
                    
                    <div class="form-group">
                        <label>CFG Scale:</label>
                        <input type="number" id="img2imgCfgScale" value="7" min="1" max="30" step="0.5">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Sampler:</label>
                        <select id="img2imgSampler">
                            <option value="DPM++ 2M Karras" selected>DPM++ 2M Karras</option>
                            <option value="Euler a">Euler a</option>
                            <option value="Euler">Euler</option>
                            <option value="DDIM">DDIM</option>
                            <option value="DPM++ SDE Karras">DPM++ SDE Karras</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Seed:</label>
                        <input type="number" id="img2imgSeed" value="-1" placeholder="-1 = Random">
                    </div>
                </div>
                
                <!-- Lora Selection for Img2Img -->
                <div class="form-group" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                    <label style="font-weight: 600;">🎨 Lora Models (Tùy chọn):</label>
                    <div id="img2imgLoraSelectionContainer" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                        <button type="button" id="addImg2imgLoraBtn" class="secondary-btn" onclick="addImg2imgLoraSelection()">
                            ➕ Thêm Lora
                        </button>
                    </div>
                </div>
                
                <!-- VAE Selection for Img2Img -->
                <div class="form-group">
                    <label>🔧 VAE Model:</label>
                    <select id="img2imgVaeSelect">
                        <option value="">Automatic (Mặc định)</option>
                    </select>
                </div>

                <button class="generate-btn btn-primary w-full py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-glow transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98]" id="generateImg2ImgBtn" onclick="generateImg2Img()" disabled>
                    🎨 Tạo ảnh từ hình ảnh
                </button>

            </div>
            <!-- End Img2Img Tab -->
            
            <!-- Nút đóng ở cuối modal -->
            <button class="modal-footer-close btn-secondary w-full py-3 rounded-xl font-semibold mt-4 hover:bg-gray-600 hover:text-white transition-all duration-200" onclick="closeImageModal()">
                ✓ Đóng
            </button>
            
            <!-- Generated Image Overlay Modal -->
            <div id="generatedImageContainer" class="generated-image-overlay" style="display: none;" onclick="closeGeneratedImageOverlay(event)">
                <div class="generated-image-modal" onclick="event.stopPropagation()">
                    <button class="generated-image-close" onclick="closeGeneratedImageOverlay()">&times;</button>
                    <img id="generatedImage" class="generated-image-preview" alt="Generated Image">
                    <div class="image-actions">
                        <button class="share-btn" onclick="shareImageToImgBB()" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            🔗 Share (ImgBB)
                        </button>
                        <button class="download-image-btn" onclick="downloadGeneratedImage()">
                            📥 Tải xuống
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Preview Modal (Discord-style) -->
    <div id="imagePreviewModal" class="image-preview-modal">
        <div class="image-preview-controls">
            <button class="preview-control-btn" onclick="downloadPreviewImage()" title="Download">
                📥
            </button>
            <button class="preview-control-btn" onclick="zoomPreviewImage(-0.2)" title="Zoom Out">
                🔍-
            </button>
            <button class="preview-control-btn" onclick="zoomPreviewImage(0.2)" title="Zoom In">
                🔍+
            </button>
            <button class="preview-control-btn" onclick="resetPreviewZoom()" title="Reset Zoom">
                ⟲
            </button>
        </div>
        <span class="image-preview-close" onclick="closeImagePreview()">&times;</span>
        <img id="imagePreviewContent" class="image-preview-content" src="" alt="Preview">
        <div id="imagePreviewInfo" class="image-preview-info"></div>
    </div>
    
    <!-- Message History Modal -->
    <div id="historyModal" class="history-modal" style="display: none;">
        <div class="history-modal-content animate-slide-up glass-dark backdrop-blur-xl rounded-2xl shadow-2xl max-w-3xl w-full p-5">
            <div class="modal-header flex justify-between items-center mb-4 pb-4 border-b border-gray-200/20 dark:border-gray-700/50">
                <h2 data-lang-key="history.title" class="text-xl font-bold text-gradient">📜 Lịch sử chỉnh sửa</h2>
                <button onclick="closeHistoryModal()" class="btn-secondary px-4 py-2 rounded-lg hover:bg-red-500 hover:text-white hover:border-red-500 transition-all duration-200" data-lang-key="history.close">Đóng</button>
            </div>
            <div id="historyContent" class="overflow-y-auto max-h-[60vh] scrollbar-thin"></div>
        </div>
    </div>
    
    <!-- Gallery Modal -->
    <div id="galleryModal" class="gallery-modal" style="display: none;">
        <div class="gallery-modal-content animate-slide-up glass-dark backdrop-blur-xl rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden">
            <div class="modal-header flex justify-between items-center p-5 border-b border-gray-200/20 dark:border-gray-700/50">
                <h2 class="text-xl font-bold text-gradient">🖼️ Gallery Ảnh Đã Tạo</h2>
                <div class="flex gap-3 items-center">
                    <button class="gallery-refresh-btn btn-secondary px-4 py-2 rounded-lg hover:shadow-glow-sm transition-all duration-200" onclick="refreshGallery()" title="Tải lại">
                        🔄 Refresh
                    </button>
                    <button class="close-modal btn-secondary w-10 h-10 rounded-full flex items-center justify-center text-xl hover:bg-red-500 hover:text-white hover:border-red-500 transition-all duration-200" onclick="closeGallery()">&times;</button>
                </div>
            </div>
            <div class="gallery-stats p-4 text-gray-600 dark:text-gray-400 text-sm border-b border-gray-200/20 dark:border-gray-700/30" id="galleryStats">
                Đang tải...
            </div>
            <div class="gallery-grid p-4 overflow-y-auto max-h-[calc(90vh-150px)] scrollbar-thin" id="galleryGrid">
                <!-- Gallery items will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Custom Prompt Modal -->
    <div id="customPromptModal" class="modal" style="display: none;">
        <div class="modal-content animate-slide-up glass-dark backdrop-blur-xl rounded-2xl shadow-2xl max-w-2xl w-full p-6">
            <div class="modal-header flex justify-between items-center mb-5 pb-4 border-b border-gray-200/20 dark:border-gray-700/50">
                <h2 class="text-xl font-bold text-gradient">🛠️ <span data-lang-key="customPrompt.title">Custom System Prompt</span></h2>
                <button class="close-modal btn-secondary w-10 h-10 rounded-full flex items-center justify-center text-xl hover:bg-red-500 hover:text-white hover:border-red-500 transition-all duration-200" onclick="closeCustomPromptModal()">&times;</button>
            </div>
            
            <div class="form-group mb-4">
                <label data-lang-key="customPrompt.description" class="block text-sm text-gray-600 dark:text-gray-300 mb-3">
                    Nhập system prompt tùy chỉnh của bạn. Nếu để trống, ChatBot sẽ sử dụng base prompt mặc định.
                </label>
                <textarea 
                    id="customPromptText" 
                    rows="10" 
                    placeholder="Ví dụ: Bạn là một chuyên gia về lập trình Python với 10 năm kinh nghiệm..."
                    data-lang-key="customPrompt.placeholder"
                    class="w-full input-field rounded-xl px-4 py-3 font-mono text-sm border-2 border-gray-200 dark:border-gray-600 focus:border-primary focus:ring-4 focus:ring-primary/20 transition-all duration-200 scrollbar-thin"
                ></textarea>
            </div>
            
            <div class="flex gap-3 justify-end mb-4">
                <button 
                    onclick="clearCustomPrompt()" 
                    class="btn-secondary px-5 py-2.5 rounded-lg font-medium hover:bg-red-500 hover:text-white hover:border-red-500 transition-all duration-200"
                    data-lang-key="customPrompt.clear"
                >
                    🗑️ Xóa
                </button>
                <button 
                    onclick="saveCustomPrompt()" 
                    class="btn-primary px-5 py-2.5 rounded-lg font-medium shadow-lg hover:shadow-glow transition-all duration-200"
                    data-lang-key="customPrompt.save"
                >
                    💾 Lưu
                </button>
            </div>
            
            <div class="p-4 bg-gray-100/50 dark:bg-dark-surface/50 rounded-xl text-xs text-gray-600 dark:text-gray-400">
                <strong data-lang-key="customPrompt.note" class="block mb-2 text-gray-800 dark:text-gray-200">📝 Lưu ý:</strong>
                <ul class="list-disc pl-5 space-y-1">
                    <li data-lang-key="customPrompt.note1">Custom prompt sẽ ghi đè lên prompt mặc định của chế độ hiện tại</li>
                    <li data-lang-key="customPrompt.note2">Để trống và nhấn "Lưu" để quay lại sử dụng base prompt</li>
                    <li data-lang-key="customPrompt.note3">Custom prompt được lưu trong session hiện tại</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Load JavaScript modules -->
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mcp.js') }}"></script>
    
    <!-- Temporary test script -->
    <script>
        console.log('=== INLINE TEST SCRIPT LOADED ===');
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOM READY ===');
            
            const fileInput = document.getElementById('fileInput');
            console.log('File input element:', fileInput);
            
            if (fileInput) {
                console.log('Setting up direct onchange...');
                fileInput.onchange = function(e) {
                    console.log('=== ONCHANGE FIRED (INLINE) ===');
                    console.log('Files:', e.target.files);
                    alert('File selected: ' + (e.target.files.length > 0 ? e.target.files[0].name : 'none'));
                };
                console.log('Direct onchange setup complete');
            } else {
                console.error('File input NOT FOUND!');
            }
        });
        
        // Custom Prompt Modal Functions
        // Load from localStorage on init
        let customPromptValue = localStorage.getItem('customPromptValue') || '';
        let customPromptEnabled = localStorage.getItem('customPromptEnabled') === 'true';
        
        function openCustomPromptModal() {
            const modal = document.getElementById('customPromptModal');
            const textarea = document.getElementById('customPromptText');
            textarea.value = customPromptValue || '';
            modal.style.display = 'flex';  // Use flex to center
        }
        
        function closeCustomPromptModal() {
            const modal = document.getElementById('customPromptModal');
            modal.style.display = 'none';
        }
        
        function saveCustomPrompt() {
            const textarea = document.getElementById('customPromptText');
            customPromptValue = textarea.value.trim();
            
            const btn = document.getElementById('customPromptBtn');
            const chatContainer = document.getElementById('chatContainer');
            const timestamp = new Date().toLocaleString('vi-VN');
            
            if (customPromptValue) {
                customPromptEnabled = true;  // Activate custom prompt
                // Save to localStorage
                localStorage.setItem('customPromptValue', customPromptValue);
                localStorage.setItem('customPromptEnabled', 'true');
                
                btn.classList.add('active-custom');
                btn.title = '🛠️ Custom Prompt ĐANG KÍCH HOẠT (Click để chỉnh sửa)';
                
                // Show custom prompt in chat
                if (window.chatApp && window.chatApp.messageRenderer) {
                    const promptDisplay = `✅ **Prompt đã được custom lại:**\n\n\`\`\`\n${customPromptValue}\n\`\`\``;
                    window.chatApp.messageRenderer.addMessage(
                        chatContainer,
                        promptDisplay,
                        false,
                        'System',
                        'info',
                        timestamp,
                        null,
                        true  // Show as Custom Prompt
                    );
                }
            } else {
                customPromptEnabled = false;  // Deactivate if empty
                // Remove from localStorage
                localStorage.removeItem('customPromptValue');
                localStorage.removeItem('customPromptEnabled');
                
                btn.classList.remove('active-custom');
                btn.title = 'Tùy chỉnh System Prompt';
            }
            
            closeCustomPromptModal();
        }
        
        function clearCustomPrompt() {
            customPromptValue = '';
            customPromptEnabled = false;  // Deactivate custom prompt
            document.getElementById('customPromptText').value = '';
            
            // Remove from localStorage
            localStorage.removeItem('customPromptValue');
            localStorage.removeItem('customPromptEnabled');
            
            const btn = document.getElementById('customPromptBtn');
            btn.classList.remove('active-custom');
            btn.title = 'Tùy chỉnh System Prompt';
            
            // Show deletion message in chat
            const chatContainer = document.getElementById('chatContainer');
            const timestamp = new Date().toLocaleString('vi-VN');
            if (window.chatApp && window.chatApp.messageRenderer) {
                window.chatApp.messageRenderer.addMessage(
                    chatContainer,
                    '🗑️ **Đã xóa custom prompt** - Quay lại sử dụng base prompt',
                    false,
                    'System',
                    'info',
                    timestamp,
                    null,
                    false
                );
            }
            
            closeCustomPromptModal();
        }
        
        // Add event listener for Custom Prompt button
        document.addEventListener('DOMContentLoaded', function() {
            const customPromptBtn = document.getElementById('customPromptBtn');
            if (customPromptBtn) {
                customPromptBtn.addEventListener('click', openCustomPromptModal);
                // Restore state from localStorage
                if (customPromptEnabled) {
                    customPromptBtn.classList.add('active-custom');
                    customPromptBtn.title = '🛠️ Custom Prompt ĐANG KÍCH HOẠT (Click để chỉnh sửa)';
                }
            }
        });
    </script>
</body>
</html>
