<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ChatBot Assistant</title>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Sidebar Toggle (Mobile) -->
    <div class="sidebar-toggle" id="sidebarToggle">
        ☰
    </div>
    
    <div class="main-wrapper">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3 data-lang-key="sidebar.title">💬 Lịch sử Chat</h3>
                <button class="new-chat-btn" id="newChatBtn" data-lang-key="sidebar.newChat">+ Mới</button>
            </div>
            <div style="padding: 10px; font-size: 11px; color: #888; border-bottom: 1px solid #333;">
                <span id="storageInfo" data-lang-key="sidebar.calculating">Đang tính...</span>
            </div>
            <div class="chat-list" id="chatList">
                <!-- Chat items will be dynamically added here -->
            </div>
        </div>
        
        <!-- Main Chat Container -->
        <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="text-align: center; flex: 1;">
                    <h1 style="position: relative;" data-lang-key="app.title">🤖 AI ChatBot Assistant</h1>
                    <p data-lang-key="app.subtitle">Hỗ trợ tâm lý, tâm sự và giải pháp đời sống, hỗ trợ lập trình chung</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <a href="https://github.com/SkastVnT/AI-Assistant/tree/master/ChatBot" target="_blank" rel="noopener noreferrer" class="github-badge">
                        <svg height="24" width="24" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                        <span>@SkastVnT</span>
                    </a>
                    <button class="lang-toggle-btn" id="langBtn" title="Switch to English">🇬🇧 EN</button>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group"> 
                <label>
                    <span data-lang-key="controls.model">Model:</span>
                    <select id="modelSelect">
                        <option value="gemini" data-lang-key="model.gemini">Gemini (Google) - FREE</option>
                        <option value="grok" data-lang-key="model.grok">GROK (xAI) - FREE</option>
                        <option value="openai" data-lang-key="model.openai">GPT-4o-mini (OpenAI)</option>
                        <option value="deepseek" data-lang-key="model.deepseek">DeepSeek (Rẻ nhất)</option>
                        <option value="qwen" data-lang-key="model.qwen">Qwen1.5b (Alibaba Cloud)</option>
                        <option value="bloomvn" data-lang-key="model.bloomvn">BloomVN-8B API (Tiếng Việt) - FREE</option>
                        <optgroup label="🖥️ Local Models (FREE - No Internet)" data-lang-key="model.local.group">
                            <option value="qwen1.5-local" data-lang-key="model.local.qwen15">🖥️ Qwen1.5-1.8B Local</option>
                            <option value="bloomvn-local" data-lang-key="model.local.bloomvn">🖥️ BloomVN-8B Local</option>
                            <option value="qwen2.5-local" data-lang-key="model.local.qwen25">🖥️ Qwen2.5-14B Local ⭐</option>
                        </optgroup>
                    </select>
                </label>
                
                <label>
                    <span data-lang-key="controls.mode">Chế độ:</span>
                    <select id="contextSelect">
                        <option value="casual" data-lang-key="controls.mode.casual">Trò chuyện vui vẻ</option>
                        <option value="psychological" data-lang-key="controls.mode.psychological">Tâm lý - Tâm sự</option>
                        <option value="lifestyle" data-lang-key="controls.mode.lifestyle">Giải pháp đời sống</option>
                        <option value="programming" data-lang-key="controls.mode.programming">💻 Hỗ trợ lập trình</option>
                    </select>
                </label>
                
                <div class="checkbox-container" id="deepThinkingContainer">
                    <input type="checkbox" id="deepThinkingCheck">
                    <label for="deepThinkingCheck" data-lang-key="controls.deepThinking">🧠 Suy luận sâu</label>
                </div>
                
                <button class="download-btn" id="downloadBtn" title="Tải xuống lịch sử chat" data-lang-key="controls.download" data-lang-key-title="tooltip.download">
                    📥 Tải chat
                </button>
                <button class="image-gen-btn" id="imageGenBtn" title="Tạo ảnh bằng AI" data-lang-key="controls.imageGen" data-lang-key-title="tooltip.imageGen">
                    🎨 Tạo ảnh
                </button>
                <button class="memory-btn" id="memoryBtn" title="Quản lý bộ nhớ AI" data-lang-key="controls.memory" data-lang-key-title="tooltip.memory">
                    🧠 AI học tập
                </button>
                <button class="dark-mode-toggle" id="darkModeBtn" title="Toggle Dark Mode" data-lang-key-title="tooltip.darkMode">🌙</button>
                <button id="clearBtn" data-lang-key="controls.clear">🗑️ Xóa lịch sử</button>
            </div>
        </div>
        
        <!-- Main Content Area with Chat and MCP File Browser -->
        <div class="content-wrapper">
            <!-- Chat Container (Left) -->
            <div class="chat-section">
                <div class="chat-container" id="chatContainer">
                    <div class="message assistant">
                        <div class="message-content">
                            <div data-lang-key="chat.welcome">Xin chào! Tôi là trợ lý AI của bạn. Tôi có thể giúp gì cho bạn hôm nay? 😊</div>
                            <div class="message-info">Gemini • <span data-lang-key="controls.mode.casual">Trò chuyện vui vẻ</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Memory Panel (hidden by default) -->
                <div class="memory-panel" id="memoryPanel" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong data-lang-key="memory.title">📚 Bài học đã lưu (chọn để kích hoạt):</strong>
                        <button class="new-chat-btn" id="saveMemoryBtn" style="padding: 5px 12px; font-size: 12px;" data-lang-key="memory.save">
                            💾 Lưu chat này
                        </button>
                    </div>
                    <div id="memoryList">
                        <!-- Memory items will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- MCP Toggle Button (Always Visible) -->
            <button class="mcp-toggle-btn" id="mcpToggleBtn" title="Mở rộng MCP">
                ▶
            </button>
            
            <!-- MCP File Browser Sidebar (Right) -->
            <div class="mcp-sidebar" id="mcpSidebar">
                <div class="mcp-sidebar-header">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <input type="checkbox" id="mcpEnabledCheck">
                        <label for="mcpEnabledCheck" style="margin: 0; font-weight: 600;">
                            🔗 <span data-lang-key="mcp.enable">MCP File Browser</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button class="mcp-btn" id="mcpSelectFolderBtn" disabled>
                            📁 <span data-lang-key="mcp.selectFolder">Chọn folder</span>
                        </button>
                        <span id="mcpStatus" class="mcp-status-badge">
                            <span data-lang-key="mcp.status.disabled">⚪ Tắt</span>
                        </span>
                    </div>
                    <div id="mcpFolderList" class="mcp-folder-tags" style="display: none;">
                        <!-- Selected folders will appear here -->
                    </div>
                </div>
                
                <div class="mcp-file-browser" id="mcpFileBrowser">
                    <div class="mcp-search-box">
                        <input type="text" id="mcpFileSearch" placeholder="🔍 Tìm file..." disabled>
                    </div>
                    <div class="mcp-file-list" id="mcpFileList">
                        <div class="mcp-empty-state">
                            <p>📂 Chưa chọn folder</p>
                            <p style="font-size: 11px; color: #888;">Bật MCP và chọn folder để xem files</p>
                        </div>
                    </div>
                </div>
                
                <div class="mcp-selected-files" id="mcpSelectedFiles" style="display: none;">
                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #667eea;">
                        📌 Files đã chọn (<span id="selectedFileCount">0</span>)
                    </div>
                    <div id="selectedFileList"></div>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <span id="loadingText" data-lang-key="loading.thinking">Đang suy nghĩ...</span>
            <button class="stop-generation-btn" id="stopGenerationBtn" data-lang-key="loading.stop">⏹️ Dừng lại</button>
        </div>
        
        <div class="input-container">
            <div class="input-tools">
                <button class="tool-btn" id="customPromptBtn" title="Tùy chỉnh System Prompt" data-lang-key="tools.customPrompt" data-lang-key-title="tooltip.customPrompt">
                    🛠️ Custom Prompt
                </button>
                <button class="tool-btn" id="googleSearchBtn" title="Tìm kiếm Google" data-lang-key="tools.googleSearch" data-lang-key-title="tooltip.googleSearch">
                    🔍 Google Search
                </button>
                <button class="tool-btn" id="githubBtn" title="Kết nối GitHub" data-lang-key-title="tooltip.github">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    <span data-lang-key="tools.github">GitHub</span>
                </button>
                <button class="tool-btn" id="imageGenToolBtn" title="Tạo ảnh từ text prompt (Text2Img)" data-lang-key="tools.text2img" data-lang-key-title="tooltip.text2img">
                    🎨 Text2Img
                </button>
                <button class="tool-btn" id="img2imgToolBtn" title="Tạo ảnh từ upload (Img2Img)" data-lang-key="tools.img2img" data-lang-key-title="tooltip.img2img">
                    🖼️ Img2Img
                </button>
                <button class="tool-btn" id="uploadFilesBtn" title="Upload tài liệu (txt, pdf, doc, code files)" data-lang-key="tools.uploadFiles" data-lang-key-title="tooltip.uploadFiles">
                    📎 Upload Files
                </button>
                <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.json,.py,.js,.html,.css,.xlsx,.csv,image/*" multiple style="display: none;">
            </div>
            <div class="file-list" id="fileList">
                <!-- Uploaded files will appear here -->
            </div>
            <div class="input-group">
                <textarea 
                    id="messageInput" 
                    placeholder="Nhập tin nhắn của bạn... (Shift+Enter để xuống dòng, Ctrl+V để paste)"
                    data-lang-key="input.placeholder"
                    rows="1"
                ></textarea>
                <button id="sendBtn" data-lang-key="input.send">Gửi</button>
            </div>
        </div>
        </div> <!-- Close container -->
    </div> <!-- Close main-wrapper -->
    
    <!-- Image Generation Modal -->
    <div id="imageGenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-lang-key="imageGen.title">🎨 Tạo ảnh bằng AI</h2>
                <button class="close-modal" onclick="closeImageModal()">&times;</button>
            </div>
            
            <div id="sdStatus" class="sd-status offline" data-lang-key="imageGen.status.checking">
                Đang kiểm tra Stable Diffusion...
            </div>

            <!-- Tab Navigation -->
            <div class="image-gen-tabs">
                <button class="tab-btn active" onclick="switchImageGenTab('text2img')" data-lang-key="imageGen.tab.text2img">
                    ✍️ Tạo ảnh từ prompt
                </button>
                <button class="tab-btn" onclick="switchImageGenTab('img2img')" data-lang-key="imageGen.tab.img2img">
                    🖼️ Tạo ảnh theo hình ảnh
                </button>
            </div>

            <!-- Shared Model Selection -->
            <div class="form-group">
                <label data-lang-key="imageGen.model">Model Checkpoint:</label>
                <select id="modelCheckpoint">
                    <option value="" data-lang-key="imageGen.model.loading">Đang tải...</option>
                </select>
            </div>

            <!-- Text2Img Tab Content -->
            <div id="text2imgTab" class="tab-content active">
            
            <div class="form-group">
                <label data-lang-key="imageGen.prompt">Prompt (Mô tả ảnh bạn muốn tạo):</label>
                <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                    <button onclick="randomPrompt()" style="padding: 5px 15px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" data-lang-key="imageGen.random">🎲 Random</button>
                </div>
                <textarea id="imagePrompt" rows="4" placeholder="1girl, beautiful, detailed face, long hair, cherry blossoms, sunset, masterpiece, best quality" data-lang-key="imageGen.prompt.placeholder"></textarea>
            </div>
            
            <div class="form-group">
                <label data-lang-key="imageGen.negativePrompt">Negative Prompt (Những gì KHÔNG muốn có):</label>
                <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                    <button onclick="randomNegativePrompt()" style="padding: 5px 15px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" data-lang-key="imageGen.random">🎲 Random</button>
                </div>
                <textarea id="negativePrompt" rows="3" placeholder="bad quality, blurry, distorted, ugly, worst quality" data-lang-key="imageGen.negativePrompt.placeholder"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label data-lang-key="imageGen.width">Width:</label>
                    <select id="imageWidth">
                        <option value="512" selected>512 (Safe)</option>
                        <option value="768">768</option>
                        <option value="1024">1024</option>
                        <option value="1280">1280</option>
                        <option value="1440">1440 (HD)</option>
                        <option value="1920">1920 (FHD)</option>
                        <option value="2560">2560 (4K HD)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label data-lang-key="imageGen.height">Height:</label>
                    <select id="imageHeight">
                        <option value="512" selected>512 (Safe)</option>
                        <option value="768">768</option>
                        <option value="1024">1024</option>
                        <option value="1280">1280</option>
                        <option value="1440">1440 (HD)</option>
                        <option value="1920">1920 (FHD)</option>
                        <option value="2560">2560 (4K HD)</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label><span data-lang-key="imageGen.steps">Steps</span> <span id="stepsLabel" data-lang-key="imageGen.stepsHint">(20-50 khuyến nghị)</span>:</label>
                    <input type="number" id="imageSteps" value="20" min="1" max="150">
                </div>
                
                <div class="form-group">
                    <label><span data-lang-key="imageGen.cfgScale">CFG Scale</span> <span id="cfgLabel" data-lang-key="imageGen.cfgHint">(7-12 khuyến nghị)</span>:</label>
                    <input type="number" id="cfgScale" value="7" min="1" max="30" step="0.5">
                </div>
            </div>
            
            <div class="form-group">
                <label data-lang-key="imageGen.sampler">Sampler:</label>
                <select id="samplerSelect">
                    <option value="DPM++ 2M Karras" selected>DPM++ 2M Karras</option>
                    <option value="Euler a">Euler a</option>
                    <option value="Euler">Euler</option>
                    <option value="DDIM">DDIM</option>
                    <option value="DPM++ SDE Karras">DPM++ SDE Karras</option>
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="restoreFaces">
                        <span data-lang-key="imageGen.restoreFaces">Restore Faces (GFPGAN)</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableHR">
                        <span data-lang-key="imageGen.hiresfix">Hires. Fix (Chất lượng cao)</span>
                    </label>
                </div>
            </div>
            
            <!-- Lora Selection Section -->
            <div class="form-group" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <label style="font-weight: 600;" data-lang-key="imageGen.lora">🎨 Lora Models (Tùy chọn):</label>
                <div id="loraSelectionContainer" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                    <button type="button" id="addLoraBtn" class="secondary-btn" onclick="addLoraSelection()" data-lang-key="imageGen.addLora">
                        ➕ Thêm Lora
                    </button>
                </div>
            </div>
            
            <!-- VAE Selection -->
            <div class="form-group">
                <label>🔧 VAE Model:</label>
                <select id="vaeSelect">
                    <option value="">Automatic (Mặc định)</option>
                </select>
            </div>
            
            <button class="generate-btn" id="generateImageBtn" onclick="generateImage()">
                🎨 Tạo ảnh
            </button>

            </div>
            <!-- End Text2Img Tab -->

            <!-- Img2Img Tab Content -->
            <div id="img2imgTab" class="tab-content" style="display: none;">
                
                <!-- Mode Selection -->
                <div class="form-group" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <label style="color: white; font-weight: 600; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="smartModeToggle" onchange="toggleImg2ImgMode()" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>🧠 Smart Mode - Tự động tạo dựa trên đặc trưng ảnh (80% Features + 20% Prompt)</span>
                    </label>
                    <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin: 8px 0 0 30px;">
                        ✨ Bật để tự động trích xuất và tạo ảnh giống ảnh gốc. Tắt để kiểm soát hoàn toàn.
                    </p>
                </div>
                
                <!-- Upload Image Section -->
                <div class="form-group">
                    <label>📤 Upload hình ảnh gốc (Bắt buộc):</label>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('sourceImage').click()">
                        <div id="uploadPlaceholder">
                            <span style="font-size: 48px;">📷</span>
                            <p>Click để chọn ảnh hoặc kéo thả vào đây</p>
                            <p style="font-size: 12px; color: #999;">Hỗ trợ: JPG, PNG, WebP</p>
                        </div>
                        <img id="sourceImagePreview" style="display: none; max-width: 100%; max-height: 300px; border-radius: 8px;">
                    </div>
                    <input type="file" id="sourceImage" accept="image/*" style="display: none;" onchange="handleSourceImageUpload(event)">
                </div>

                <!-- Extract Features Section -->
                <div id="featureExtractionSection" style="display: none;">
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <label style="font-weight: 600; font-size: 15px;">🔍 Trích xuất đặc trưng</label>
                            <span style="font-size: 12px; color: #888;">Sử dụng DeepDanbooru 🎨</span>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="extract-btn" onclick="extractFeatures()" style="flex: 1; padding: 12px; margin-bottom: 15px; background: linear-gradient(135deg, #ff9800, #ff5722); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s;">
                                🔬 Trích xuất đặc trưng
                            </button>
                            
                            <button class="grok-prompt-btn" onclick="generatePromptFromGrok()" style="flex: 1; padding: 12px; margin-bottom: 15px; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s;" disabled id="grokPromptBtn">
                                ✨ Tự tạo prompt (GROK)
                            </button>
                        </div>
                        
                        <div id="extractedTags" style="display: none;">
                            <div style="margin-bottom: 10px; padding: 10px; background: rgba(103, 126, 234, 0.1); border-left: 3px solid #667eea; border-radius: 4px; font-size: 13px;">
                                💡 <strong>Tip:</strong> Click vào tag để loại bỏ khỏi prompt
                            </div>
                            <div id="tagsList" style="max-height: 400px; overflow-y: auto; border-radius: 8px;">
                                <!-- Tags will be populated here by category -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prompt Section for Img2Img -->
                <div class="form-group" id="img2imgPromptSection">
                    <label>
                        <span id="promptLabelText">Prompt bổ sung (có thể tùy chỉnh % bên dưới):</span>
                        <span id="smartModeHint" style="display: none; color: #888; font-size: 12px; margin-left: 10px;">
                            (Chỉ chiếm <span id="promptPercentage">20</span>% ảnh hưởng)
                        </span>
                    </label>
                    <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                        <button onclick="randomImg2ImgPrompt()" style="padding: 5px 15px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🎲 Random</button>
                    </div>
                    <textarea id="img2imgPrompt" rows="3" placeholder="Nhập prompt bổ sung để điều chỉnh ảnh..."></textarea>
                </div>

                <div class="form-group">
                    <label>Negative Prompt:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                        <button onclick="randomImg2ImgNegativePrompt()" style="padding: 5px 15px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🎲 Random</button>
                    </div>
                    <textarea id="img2imgNegativePrompt" rows="2" placeholder="bad quality, blurry, distorted"></textarea>
                </div>

                <!-- Image Size for Img2Img -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Width:</label>
                        <select id="img2imgWidth">
                            <option value="512">512</option>
                            <option value="768" selected>768</option>
                            <option value="1024">1024</option>
                            <option value="1280">1280</option>
                            <option value="1440">1440 (HD)</option>
                            <option value="1920">1920 (FHD)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Height:</label>
                        <select id="img2imgHeight">
                            <option value="512">512</option>
                            <option value="768" selected>768</option>
                            <option value="1024">1024</option>
                            <option value="1280">1280</option>
                            <option value="1440">1440 (HD)</option>
                            <option value="1920">1920 (FHD)</option>
                        </select>
                    </div>
                </div>

                <!-- Generation Settings for Img2Img -->
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            Denoising Strength:
                            <span style="font-size: 11px; color: #888;" id="denoisingHint">(0.6-0.8 Manual / 0.3-0.5 Smart)</span>
                        </label>
                        <input type="number" id="denoisingStrength" value="0.6" min="0" max="1" step="0.05">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            Feature Weight (%):
                            <span style="font-size: 11px; color: #888;">(Smart mode only)</span>
                        </label>
                        <input type="number" id="featureWeight" value="80" min="0" max="100" step="5" disabled>
                    </div>
                </div>
                
                <!-- Deep Thinking Toggle for Smart Mode -->
                <div class="form-group" id="deepThinkingImg2Img" style="display: none; background: rgba(76, 175, 80, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid #4CAF50;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="deepThinkingExtract" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600;">🧠 Suy luận sâu (Chậm hơn nhưng kỹ hơn)</span>
                    </label>
                    <p style="font-size: 12px; color: #666; margin: 8px 0 0 28px;">
                        Trích xuất đặc trưng chi tiết hơn, tăng steps lên 50-70
                    </p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Steps:</label>
                        <input type="number" id="img2imgSteps" value="30" min="1" max="150">
                    </div>
                    
                    <div class="form-group">
                        <label>CFG Scale:</label>
                        <input type="number" id="img2imgCfgScale" value="7" min="1" max="30" step="0.5">
                    </div>
                </div>
                
                <!-- Sampler for Img2Img -->
                <div class="form-group">
                    <label>Sampler:</label>
                    <select id="img2imgSampler">
                        <option value="DPM++ 2M Karras" selected>DPM++ 2M Karras</option>
                        <option value="Euler a">Euler a</option>
                        <option value="Euler">Euler</option>
                        <option value="DDIM">DDIM</option>
                        <option value="DPM++ SDE Karras">DPM++ SDE Karras</option>
                    </select>
                </div>
                
                <!-- Lora Selection for Img2Img -->
                <div class="form-group" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                    <label style="font-weight: 600;">🎨 Lora Models (Tùy chọn):</label>
                    <div id="img2imgLoraList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                        <!-- LoRA checkboxes will be populated here -->
                    </div>
                </div>
                
                <!-- VAE Selection for Img2Img -->
                <div class="form-group">
                    <label>🔧 VAE Model:</label>
                    <select id="img2imgVaeSelect">
                        <option value="">Automatic (Mặc định)</option>
                    </select>
                </div>

                <button class="generate-btn" id="generateImg2ImgBtn" onclick="generateImg2Img()" disabled>
                    🎨 Tạo ảnh từ hình ảnh
                </button>

            </div>
            <!-- End Img2Img Tab -->
            
            <div id="generatedImageContainer" style="display: none;">
                <img id="generatedImage" class="generated-image" alt="Generated Image">
                <div class="image-actions">
                    <button class="copy-to-chat-btn" onclick="copyImageToChat()">
                        💬 Gửi vào Chat
                    </button>
                    <button class="download-image-btn" onclick="downloadGeneratedImage()">
                        📥 Tải xuống
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Preview Modal (Discord-style) -->
    <div id="imagePreviewModal" class="image-preview-modal">
        <div class="image-preview-controls">
            <button class="preview-control-btn" onclick="downloadPreviewImage()" title="Download">
                📥
            </button>
            <button class="preview-control-btn" onclick="zoomPreviewImage(-0.2)" title="Zoom Out">
                🔍-
            </button>
            <button class="preview-control-btn" onclick="zoomPreviewImage(0.2)" title="Zoom In">
                🔍+
            </button>
            <button class="preview-control-btn" onclick="resetPreviewZoom()" title="Reset Zoom">
                ⟲
            </button>
        </div>
        <span class="image-preview-close" onclick="closeImagePreview()">&times;</span>
        <img id="imagePreviewContent" class="image-preview-content" src="" alt="Preview">
        <div id="imagePreviewInfo" class="image-preview-info"></div>
    </div>
    
    <!-- Message History Modal -->
    <div id="historyModal" class="history-modal">
        <div class="history-modal-content">
            <div class="modal-header">
                <h2 data-lang-key="history.title">📜 Lịch sử chỉnh sửa</h2>
                <button onclick="closeHistoryModal()" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;" data-lang-key="history.close">Đóng</button>
            </div>
            <div id="historyContent"></div>
        </div>
    </div>
    
    <!-- Custom Prompt Modal -->
    <div id="customPromptModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; margin: 50px auto;">
            <div class="modal-header">
                <h2>🛠️ <span data-lang-key="customPrompt.title">Custom System Prompt</span></h2>
                <button class="close-modal" onclick="closeCustomPromptModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label data-lang-key="customPrompt.description">
                    Nhập system prompt tùy chỉnh của bạn. Nếu để trống, ChatBot sẽ sử dụng base prompt mặc định.
                </label>
                <textarea 
                    id="customPromptText" 
                    rows="10" 
                    placeholder="Ví dụ: Bạn là một chuyên gia về lập trình Python với 10 năm kinh nghiệm..."
                    data-lang-key="customPrompt.placeholder"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: monospace; font-size: 14px;"
                ></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                <button 
                    onclick="clearCustomPrompt()" 
                    class="secondary-btn"
                    data-lang-key="customPrompt.clear"
                    style="padding: 10px 20px; background: #888; color: white; border: none; border-radius: 8px; cursor: pointer;"
                >
                    🗑️ Xóa
                </button>
                <button 
                    onclick="saveCustomPrompt()" 
                    class="primary-btn"
                    data-lang-key="customPrompt.save"
                    style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;"
                >
                    💾 Lưu
                </button>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 8px; font-size: 12px;">
                <strong data-lang-key="customPrompt.note">📝 Lưu ý:</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li data-lang-key="customPrompt.note1">Custom prompt sẽ ghi đè lên prompt mặc định của chế độ hiện tại</li>
                    <li data-lang-key="customPrompt.note2">Để trống và nhấn "Lưu" để quay lại sử dụng base prompt</li>
                    <li data-lang-key="customPrompt.note3">Custom prompt được lưu trong session hiện tại</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Load JavaScript modules -->
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mcp.js') }}"></script>
    
    <!-- Temporary test script -->
    <script>
        console.log('=== INLINE TEST SCRIPT LOADED ===');
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOM READY ===');
            
            const fileInput = document.getElementById('fileInput');
            console.log('File input element:', fileInput);
            
            if (fileInput) {
                console.log('Setting up direct onchange...');
                fileInput.onchange = function(e) {
                    console.log('=== ONCHANGE FIRED (INLINE) ===');
                    console.log('Files:', e.target.files);
                    alert('File selected: ' + (e.target.files.length > 0 ? e.target.files[0].name : 'none'));
                };
                console.log('Direct onchange setup complete');
            } else {
                console.error('File input NOT FOUND!');
            }
        });
        
        // Custom Prompt Modal Functions
        // Load from localStorage on init
        let customPromptValue = localStorage.getItem('customPromptValue') || '';
        let customPromptEnabled = localStorage.getItem('customPromptEnabled') === 'true';
        
        function openCustomPromptModal() {
            const modal = document.getElementById('customPromptModal');
            const textarea = document.getElementById('customPromptText');
            textarea.value = customPromptValue || '';
            modal.style.display = 'flex';  // Use flex to center
        }
        
        function closeCustomPromptModal() {
            const modal = document.getElementById('customPromptModal');
            modal.style.display = 'none';
        }
        
        function saveCustomPrompt() {
            const textarea = document.getElementById('customPromptText');
            customPromptValue = textarea.value.trim();
            
            const btn = document.getElementById('customPromptBtn');
            const chatContainer = document.getElementById('chatContainer');
            const timestamp = new Date().toLocaleString('vi-VN');
            
            if (customPromptValue) {
                customPromptEnabled = true;  // Activate custom prompt
                // Save to localStorage
                localStorage.setItem('customPromptValue', customPromptValue);
                localStorage.setItem('customPromptEnabled', 'true');
                
                btn.classList.add('active-custom');
                btn.title = '🛠️ Custom Prompt ĐANG KÍCH HOẠT (Click để chỉnh sửa)';
                
                // Show custom prompt in chat
                if (window.chatApp && window.chatApp.messageRenderer) {
                    const promptDisplay = `✅ **Prompt đã được custom lại:**\n\n\`\`\`\n${customPromptValue}\n\`\`\``;
                    window.chatApp.messageRenderer.addMessage(
                        chatContainer,
                        promptDisplay,
                        false,
                        'System',
                        'info',
                        timestamp,
                        null,
                        true  // Show as Custom Prompt
                    );
                }
            } else {
                customPromptEnabled = false;  // Deactivate if empty
                // Remove from localStorage
                localStorage.removeItem('customPromptValue');
                localStorage.removeItem('customPromptEnabled');
                
                btn.classList.remove('active-custom');
                btn.title = 'Tùy chỉnh System Prompt';
            }
            
            closeCustomPromptModal();
        }
        
        function clearCustomPrompt() {
            customPromptValue = '';
            customPromptEnabled = false;  // Deactivate custom prompt
            document.getElementById('customPromptText').value = '';
            
            // Remove from localStorage
            localStorage.removeItem('customPromptValue');
            localStorage.removeItem('customPromptEnabled');
            
            const btn = document.getElementById('customPromptBtn');
            btn.classList.remove('active-custom');
            btn.title = 'Tùy chỉnh System Prompt';
            
            // Show deletion message in chat
            const chatContainer = document.getElementById('chatContainer');
            const timestamp = new Date().toLocaleString('vi-VN');
            if (window.chatApp && window.chatApp.messageRenderer) {
                window.chatApp.messageRenderer.addMessage(
                    chatContainer,
                    '🗑️ **Đã xóa custom prompt** - Quay lại sử dụng base prompt',
                    false,
                    'System',
                    'info',
                    timestamp,
                    null,
                    false
                );
            }
            
            closeCustomPromptModal();
        }
        
        // Add event listener for Custom Prompt button
        document.addEventListener('DOMContentLoaded', function() {
            const customPromptBtn = document.getElementById('customPromptBtn');
            if (customPromptBtn) {
                customPromptBtn.addEventListener('click', openCustomPromptModal);
                // Restore state from localStorage
                if (customPromptEnabled) {
                    customPromptBtn.classList.add('active-custom');
                    customPromptBtn.title = '🛠️ Custom Prompt ĐANG KÍCH HOẠT (Click để chỉnh sửa)';
                }
            }
        });
    </script>
</body>
</html>
