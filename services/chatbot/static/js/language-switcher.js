/**
 * Language switcher module for ChatBot
 * Handles language switching between Vietnamese and English
 */

import translations from './translations.js';
import { translationService } from './translation-service.js';

// Current language (default: Vietnamese)
let currentLanguage = localStorage.getItem('chatbot_language') || 'vi';

/**
 * Apply language translations to all elements with data-lang-key attribute
 */
export async function applyLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('chatbot_language', lang);
    
    // Update HTML lang attribute
    document.documentElement.lang = lang;
    
    // NOTE: Chat titles are auto-generated by Gemini in the correct language
    // No need to translate them manually
    
    // Update all elements with data-lang-key
    const elements = document.querySelectorAll('[data-lang-key]');
    elements.forEach(element => {
        const key = element.getAttribute('data-lang-key');
        const translation = translations[lang][key];
        
        if (translation) {
            // Handle different element types
            if (element.tagName === 'INPUT') {
                if (element.type === 'text' || element.type === 'search') {
                    element.placeholder = translation;
                } else if (element.type === 'button' || element.type === 'submit') {
                    element.value = translation;
                }
            } else if (element.tagName === 'TEXTAREA') {
                element.placeholder = translation;
            } else if (element.tagName === 'OPTION') {
                element.textContent = translation;
            } else if (element.tagName === 'OPTGROUP') {
                element.label = translation;
            } else if (element.hasAttribute('title') && key.includes('tooltip')) {
                element.title = translation;
            } else {
                element.textContent = translation;
            }
        }
    });
    
    // Update elements with data-lang-key-title (for tooltips)
    const tooltipElements = document.querySelectorAll('[data-lang-key-title]');
    tooltipElements.forEach(element => {
        const key = element.getAttribute('data-lang-key-title');
        const translation = translations[lang][key];
        if (translation) {
            element.title = translation;
        }
    });
    
    // Update language button text
    const langBtn = document.getElementById('langBtn');
    if (langBtn) {
        langBtn.textContent = lang === 'vi' ? 'ðŸ‡¬ðŸ‡§ EN' : 'ðŸ‡»ðŸ‡³ VI';
        langBtn.title = lang === 'vi' ? 'Switch to English' : 'Chuyá»ƒn sang tiáº¿ng Viá»‡t';
    }
    
    console.log(`Language switched to: ${lang}`);
}

/**
 * Toggle between Vietnamese and English
 */
export function toggleLanguage() {
    const newLang = currentLanguage === 'vi' ? 'en' : 'vi';
    applyLanguage(newLang);
}

/**
 * Get current language
 */
export function getCurrentLanguage() {
    return currentLanguage;
}

/**
 * Get translation for a specific key
 */
export function t(key) {
    return translations[currentLanguage][key] || key;
}

/**
 * Initialize language on page load
 */
export function initLanguage() {
    applyLanguage(currentLanguage);
    
    // Add event listener to language button
    const langBtn = document.getElementById('langBtn');
    if (langBtn) {
        langBtn.addEventListener('click', toggleLanguage);
    }
}

// Auto-initialize when module loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLanguage);
} else {
    initLanguage();
}
