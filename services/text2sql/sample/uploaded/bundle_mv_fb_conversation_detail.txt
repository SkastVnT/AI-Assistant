-- FILE: chotdonai_cs.mv_fb_conversation_detail.txt
CREATE MATERIALIZED VIEW chotdonai_cs.mv_fb_conversation_detail
            TO chotdonai_cs.fb_conversation_detail_final
            (
             `_id` String,
             `conversation_id` String,
             `shop_id` String,
             `addresses` String,
             `channel_info` String,
             `conversation_type` String,
             `created_at` Nullable(DateTime64(6)),
             `deleted_at` Nullable(DateTime64(6)),
             `elasticsearch_text_search` String,
             `fb_page_id` String,
             `fb_user_id` String,
             `has_address` Nullable(UInt8),
             `has_phone` Nullable(UInt8),
             `is_enable_ai_bot` Nullable(UInt8),
             `is_read` Nullable(UInt8),
             `is_user_message` Nullable(UInt8),
             `key` String,
             `labels` String,
             `last_message` String,
             `last_message_from` String,
             `members` String,
             `phone_numbers` String,
             `pinned_message_ids` String,
             `read_at` Nullable(DateTime64(6)),
             `read_by` String,
             `sender` String,
             `source` String,
             `source_id` String,
             `staff_id` String,
             `staff_type` String,
             `state` String,
             `tag_ids` String,
             `text_search` String,
             `total_unread` Nullable(Int32),
             `updated_at` Nullable(DateTime64(6)),
             `updated_time` Nullable(DateTime64(6)),
             `user_info` String,
             `last_message_type` String
                )
AS
SELECT JSONExtractString(JSONExtractString(message, 'fullDocument'), '_id')                             AS _id,
       JSONExtractString(JSONExtractString(message, 'fullDocument'),
                         'conversation_id')                                                             AS conversation_id,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'shop_id')                         AS shop_id,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'addresses')                       AS addresses,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'channel_info')                    AS channel_info,
       JSONExtractString(JSONExtractString(message, 'fullDocument'),
                         'conversation_type')                                                           AS conversation_type,
       multiIf(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'created_at') = '', NULL,
               JSONExtractString(JSONExtractString(message, 'fullDocument'), 'created_at') = 'null', NULL,
               parseDateTime64BestEffort(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'created_at'),
                                         6))                                                            AS created_at,
       multiIf(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'deleted_at') = '', NULL,
               JSONExtractString(JSONExtractString(message, 'fullDocument'), 'deleted_at') = 'null', NULL,
               parseDateTime64BestEffort(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'deleted_at'),
                                         6))                                                            AS deleted_at,
       JSONExtractString(JSONExtractString(message, 'fullDocument'),
                         'elasticsearch_text_search')                                                   AS elasticsearch_text_search,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'fb_page_id')                      AS fb_page_id,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'fb_user_id')                      AS fb_user_id,
       toUInt8OrNull(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'has_address'))      AS has_address,
       toUInt8OrNull(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'has_phone'))        AS has_phone,
       toUInt8OrNull(JSONExtractString(JSONExtractString(message, 'fullDocument'),
                                       'is_enable_ai_bot'))                                             AS is_enable_ai_bot,
       toUInt8OrNull(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'is_read'))          AS is_read,
       toUInt8OrNull(JSONExtractString(JSONExtractString(message, 'fullDocument'),
                                       'is_user_message'))                                              AS is_user_message,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'key')                             AS key,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'labels')                          AS labels,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'last_message')                    AS last_message,
       JSONExtractString(JSONExtractString(message, 'fullDocument'),
                         'last_message_from')                                                           AS last_message_from,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'members')                         AS members,
       JSONExtractString(JSONExtractString(message, 'fullDocument'),
                         'phone_numbers')                                                               AS phone_numbers,
       JSONExtractString(JSONExtractString(message, 'fullDocument'),
                         'pinned_message_ids')                                                          AS pinned_message_ids,
       multiIf(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'read_at') = '', NULL,
               JSONExtractString(JSONExtractString(message, 'fullDocument'), 'read_at') = 'null', NULL,
               parseDateTime64BestEffort(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'read_at'),
                                         6))                                                            AS read_at,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'read_by')                         AS read_by,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'sender')                          AS sender,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'source')                          AS source,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'source_id')                       AS source_id,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'staff_id')                        AS staff_id,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'staff_type')                      AS staff_type,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'state')                           AS state,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'tag_ids')                         AS tag_ids,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'text_search')                     AS text_search,
       toInt32OrNull(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'total_unread'))     AS total_unread,
       multiIf(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'updated_at') = '', NULL,
               JSONExtractString(JSONExtractString(message, 'fullDocument'), 'updated_at') = 'null', NULL,
               parseDateTime64BestEffort(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'updated_at'),
                                         6))                                                            AS updated_at,
       multiIf(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'updated_time') = '', NULL,
               JSONExtractString(JSONExtractString(message, 'fullDocument'), 'updated_time') = 'null', NULL,
               parseDateTime64BestEffort(JSONExtractString(JSONExtractString(message, 'fullDocument'), 'updated_time'),
                                         6))                                                            AS updated_time,
       JSONExtractString(JSONExtractString(message, 'fullDocument'), 'user_info')                       AS user_info,
       JSONExtractString(JSONExtractString(message, 'fullDocument'),
                         'last_message_type')                                                           AS last_message_type
FROM chotdonai_cs.`cdn.fb_conversation_detail`;


