<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text2SQL - AI Assistant</title>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- SQL highlight -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Sidebar Toggle (Mobile) -->
    <div class="sidebar-toggle" id="sidebarToggle">
        ‚ò∞
    </div>
    
    <div class="main-wrapper">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>üìä L·ªãch s·ª≠ SQL</h3>
                <button class="new-chat-btn" id="newChatBtn">+ M·ªõi</button>
            </div>
            <div style="padding: 10px; font-size: 11px; color: #888; border-bottom: 1px solid #333;">
                <span id="storageInfo">ƒêang t√≠nh...</span>
            </div>
            <div class="chat-list" id="chatList">
                <!-- Chat items will be dynamically added here -->
            </div>
        </div>
        
        <!-- Main Chat Container -->
        <div class="container">
            <div class="header">
                <h1>üóÑÔ∏è Text2SQL - AI Assistant</h1>
                <p>Chuy·ªÉn ƒë·ªïi c√¢u h·ªèi t·ª± nhi√™n th√†nh SQL queries ch√≠nh x√°c</p>
            </div>
            
            <div class="controls">
                <div class="control-group"> 
                    <label>
                        Model:
                        <select id="modelSelect">
                            <option value="grok" selected>Grok-3 (Free) - M·∫∑c ƒë·ªãnh</option>
                            <option value="openai">GPT-4o-mini (OpenAI)</option>
                            <option value="deepseek">DeepSeek (R·∫ª nh·∫•t)</option>
                        </select>
                    </label>
                    
                    <label>
                        Database:
                        <select id="dbTypeSelect">
                            <option value="clickhouse">ClickHouse</option>
                            <option value="mongodb">MongoDB</option>
                            <option value="sqlserver">SQL Server</option>
                            <option value="postgresql">PostgreSQL</option>
                            <option value="mysql">MySQL</option>
                        </select>
                    </label>
                    
                    <div class="checkbox-container" id="deepThinkingContainer">
                        <input type="checkbox" id="deepThinkingCheck">
                        <label for="deepThinkingCheck">üß† Suy lu·∫≠n s√¢u</label>
                    </div>
                    
                    <button class="upload-btn" id="uploadBtn" title="Upload schema files">
                        üì§ Upload Schema
                    </button>
                    <button class="download-btn" id="downloadBtn" title="T·∫£i xu·ªëng l·ªãch s·ª≠ SQL">
                        üì• T·∫£i SQL
                    </button>
                    <button class="memory-btn" id="learningBtn" title="Qu·∫£n l√Ω AI Learning">
                        üß† AI Learning
                    </button>
                    <button class="database-btn" id="databaseBtn" title="K·∫øt n·ªëi Database">
                        üîå Database
                    </button>
                    <button class="dark-mode-toggle" id="darkModeBtn" title="Toggle Dark Mode">üåô</button>
                    <button id="clearBtn">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection" style="display: none;">
                <div class="upload-content">
                    <h3>üì§ Upload Database Schema</h3>
                    <p style="margin-bottom: 15px; color: #666;">H·ªó tr·ª£: .txt, .sql, .json (MongoDB, ClickHouse, SQL Server, PostgreSQL, MySQL)</p>
                    
                    <div class="file-input-wrapper">
                        <input type="file" id="schemaFiles" multiple accept=".txt,.sql,.json,.jsonl" style="display: none;">
                        <button class="file-input-btn" onclick="document.getElementById('schemaFiles').click()">
                            üìÅ Ch·ªçn file schema
                        </button>
                        <span id="fileCount" style="margin-left: 10px; color: #666;">Ch∆∞a ch·ªçn file</span>
                    </div>
                    
                    <div id="fileList" style="margin-top: 15px;"></div>
                    
                    <div class="upload-actions">
                        <button class="btn-primary" id="confirmUploadBtn">‚úÖ Upload & Ph√¢n t√≠ch</button>
                        <button class="btn-secondary" id="cancelUploadBtn">‚ùå H·ªßy</button>
                    </div>
                    
                    <div id="uploadStatus" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- Schema Preview -->
            <div class="schema-preview" id="schemaPreview" style="display: none;">
                <div class="schema-header">
                    <h4>üìã Schema hi·ªán t·∫°i</h4>
                    <button class="btn-close" id="closeSchemaBtn">‚úï</button>
                </div>
                <div class="schema-content" id="schemaContent">
                    <p style="color: #666;">Ch∆∞a c√≥ schema n√†o ƒë∆∞·ª£c upload</p>
                </div>
            </div>
            
            <!-- AI Learning Modal -->
            <div class="learning-modal" id="learningModal" style="display: none;">
                <div class="learning-content">
                    <div class="learning-header">
                        <h3>üß† AI Learning - Knowledge Base</h3>
                        <button class="btn-close" id="closeLearningBtn">‚úï</button>
                    </div>
                    <div class="learning-body">
                        <div class="learning-stats">
                            <span id="knowledgeCount">0 c√¢u SQL ƒë√£ h·ªçc</span>
                        </div>
                        <div class="learning-list" id="learningList">
                            <p style="text-align: center; color: #999; padding: 20px;">Ch∆∞a c√≥ d·ªØ li·ªáu h·ªçc</p>
                        </div>
                        <div class="learning-actions">
                            <button class="btn-secondary" id="refreshLearningBtn">üîÑ Refresh</button>
                            <button class="btn-danger" id="clearLearningBtn">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="message assistant">
                    <div class="message-content">
                        <div>üëã Xin ch√†o! T√¥i l√† AI Text2SQL Assistant. H√£y upload schema c·ªßa database v√† ƒë·∫∑t c√¢u h·ªèi, t√¥i s·∫Ω chuy·ªÉn ƒë·ªïi th√†nh SQL query ch√≠nh x√°c cho b·∫°n!</div>
                        <div style="margin-top: 10px; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                            <strong>üí° T√≠nh nƒÉng m·ªõi:</strong><br>
                            ‚Ä¢ G√µ "t·∫°o c√¢u h·ªèi" ƒë·ªÉ AI t·∫°o 5 c√¢u h·ªèi m·∫´u t·ª´ schema<br>
                            ‚Ä¢ G√µ "c√¢u sql: SELECT..." ƒë·ªÉ AI h·ªçc SQL t·ª´ b·∫°n<br>
                            ‚Ä¢ Click "üß† AI Learning" ƒë·ªÉ xem c√°c SQL ƒë√£ h·ªçc
                        </div>
                        <div class="message-info">Gemini ‚Ä¢ ClickHouse</div>
                    </div>
                </div>
            </div>
            
            <div class="input-container">
                <div class="file-upload-wrapper">
                    <button class="attach-btn" id="attachBtn" title="ƒê√≠nh k√®m file">üìé</button>
                </div>
                <textarea 
                    id="userInput" 
                    placeholder="V√≠ d·ª•: Hi·ªÉn th·ªã top 10 kh√°ch h√†ng c√≥ doanh thu cao nh·∫•t trong th√°ng 10..." 
                    rows="3"
                ></textarea>
                <button id="sendBtn">
                    <span class="send-icon">‚û§</span>
                </button>
            </div>
            
            <div class="status-bar">
                <span id="statusText">S·∫µn s√†ng</span>
                <span id="wordCount">0 k√Ω t·ª±</span>
            </div>
        </div>
    </div>

    <!-- Upload File Input (Hidden) -->
    <input type="file" id="hiddenFileInput" multiple accept=".txt,.sql,.json,.jsonl" style="display: none;">

    <!-- Database Connection Modal -->
    <div id="databaseModal" class="learning-modal" style="display: none;">
        <div class="learning-content">
            <div class="learning-header">
                <h2>üîå Database Connection</h2>
                <button class="close-btn" onclick="closeDatabaseModal()">‚úï</button>
            </div>
            <div class="learning-body">
                <div class="connection-status" id="connectionStatus">
                    <span class="status-indicator" id="statusIndicator">‚ö´</span>
                    <span id="statusMessage">Ch∆∞a k·∫øt n·ªëi</span>
                </div>

                <form id="databaseForm" class="database-form">
                    <div class="form-group">
                        <label for="dbType">Database Type:</label>
                        <select id="dbType" required>
                            <option value="clickhouse">ClickHouse</option>
                            <option value="mongodb">MongoDB</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="connectionType">Connection Type:</label>
                        <select id="connectionType" required>
                            <option value="localhost">Localhost</option>
                            <option value="atlas">MongoDB Atlas</option>
                        </select>
                    </div>

                    <div class="form-group" id="hostGroup">
                        <label for="host">Host:</label>
                        <input type="text" id="host" placeholder="localhost" value="localhost">
                    </div>

                    <div class="form-group" id="portGroup">
                        <label for="port">Port:</label>
                        <input type="text" id="port" placeholder="8123 (ClickHouse) or 27017 (MongoDB)">
                    </div>

                    <div class="form-group" id="uriGroup" style="display: none;">
                        <label for="uri">Connection URI:</label>
                        <input type="text" id="uri" placeholder="mongodb+srv://...">
                    </div>

                    <div class="form-group" id="usernameGroup">
                        <label for="username">Username:</label>
                        <input type="text" id="username" placeholder="default">
                    </div>

                    <div class="form-group" id="passwordGroup">
                        <label for="password">Password:</label>
                        <input type="password" id="password" placeholder="********">
                    </div>

                    <div class="form-group" id="databaseGroup">
                        <label for="database">Database Name:</label>
                        <input type="text" id="database" placeholder="default">
                    </div>

                    <div class="form-actions">
                        <button type="button" class="test-btn" onclick="testConnection()">
                            üîç Test Connection
                        </button>
                        <button type="button" class="save-btn" onclick="saveConnection()">
                            üíæ Save Connection
                        </button>
                    </div>
                </form>

                <div class="saved-connections" id="savedConnections">
                    <h3>üíæ Saved Connections</h3>
                    <div id="connectionsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
