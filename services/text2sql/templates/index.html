<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Chatbot Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-3xl bg-white shadow-2xl rounded-2xl flex flex-col overflow-hidden">
    
   

    <!-- Header -->
    <div class="bg-blue-600 px-6 py-4 text-white flex justify-between items-center">
      <h1 class="text-xl font-semibold">ü§ñ Chatbot Demo</h1>
      <div class="flex gap-4 text-sm">
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" id="clearChatTick" class="accent-blue-500">
          X√≥a chat
        </label>
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" id="autoCloseRequests" class="accent-blue-500" checked>
          T·ª± ƒë√≥ng y√™u c·∫ßu
        </label>
         <button id="btnShowPretrain"
            class="bg-violet-200 text-violet-800 px-4 py-2 rounded-lg shadow hover:bg-violet-300 transition">
      Xem pretrain
    </button>
    <button id="btnPretrainMore"
      class="bg-violet-200 text-violet-800 px-4 py-2 rounded-lg shadow hover:bg-violet-300 transition">
      Pretrain th√™m
    </button>
      </div>
    </div>

    <!-- Upload schema -->
    <div class="p-5 border-b space-y-3 bg-slate-50">
      <div class="flex items-center gap-2">
        <input id="schemaFile" type="file" multiple
               accept=".txt,.csv,.json,.jsonl,.sql"
               class="flex-1 text-sm file:mr-4 file:py-2 file:px-4
                      file:rounded-md file:border-0 file:text-sm file:font-semibold
                      file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
        <button id="btnUpload"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">
          Upload
        </button>
        <button id="btnShowSchema"
                class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg shadow hover:bg-gray-300 transition">
          Xem schema
        </button>
      </div>
      <div id="uploadStatus" class="text-sm text-gray-600"></div>
      <details class="bg-white rounded-lg p-3 shadow-inner">
        <summary class="cursor-pointer font-medium text-gray-800">Xem nhanh schema</summary>
        <pre id="schemaPreview"
             class="whitespace-pre-wrap text-xs mt-2 max-h-48 overflow-y-auto p-2 border rounded bg-slate-50"></pre>
      </details>
    </div>

    <!-- Chat window -->
    <div id="chat"
         class="flex-1 p-5 space-y-3 overflow-y-auto bg-gradient-to-br from-white to-slate-50"
         style="min-height:400px; max-height:500px;">
    </div>

    <!-- Input -->
    <div class="flex items-center gap-2 border-t p-4 bg-slate-50">
      <input id="input" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..."
             class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
      <button id="btnSend"
              class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition">
        G·ª≠i
      </button>
    </div>
  </div>

  

  <script>
  // =====================================================================
  // ========================== Helpers ==================================
  // =====================================================================
  const chatBox = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const btnSend = document.getElementById("btnSend");

  function appendMsg(text, who = "bot") {
    const wrap = document.createElement("div");
    wrap.className = who === "user" ? "flex justify-end" : "flex justify-start";
    const bubble = document.createElement("div");
    bubble.className =
      who === "user"
        ? "bg-blue-500 text-white px-4 py-2 rounded-xl max-w-[80%] text-right"
        : "bg-gray-200 text-gray-800 px-4 py-2 rounded-xl max-w-[80%]";
    bubble.textContent = text;
    wrap.appendChild(bubble);
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // Box h·ªèi x√°c nh·∫≠n (kh√¥ng d√πng ID, d√πng data-action ƒë·ªÉ tr√°nh tr√πng)
  function appendConfirm(question) {
  const wrap = document.createElement("div");
  wrap.className = "flex justify-start";
  // üîñ ƒë√°nh d·∫•u l√† th·∫ª y√™u c·∫ßu
  wrap.setAttribute("data-card", "request");
  wrap.innerHTML = `
    <div class="bg-yellow-50 text-gray-800 px-4 py-3 rounded-xl max-w-[80%]">
      ‚ùì C√¢u h·ªèi n√†y ch∆∞a c√≥ trong dataset. B·∫°n c√≥ mu·ªën t√¥i t·∫°o c√¢u truy v·∫•n SQL d·ª±a tr√™n schema ƒë√£ upload kh√¥ng?
      <div class="mt-2 flex gap-2">
        <button class="px-3 py-1 rounded bg-green-600 text-white" 
                data-action="confirm-yes" data-question="${encodeURIComponent(question)}">C√≥</button>
        <button class="px-3 py-1 rounded bg-gray-500 text-white" 
                data-action="confirm-no" data-question="${encodeURIComponent(question)}">Kh√¥ng</button>
      </div>
    </div>`;
  chatBox.appendChild(wrap);
  chatBox.scrollTop = chatBox.scrollHeight;
}

  // Box l∆∞u/b·ªè qua + n√∫t t·∫°o l·∫°i
  function appendApprove(question, sql, result, source) {
  const wrap = document.createElement("div");
  wrap.className = "flex justify-start";
  wrap.setAttribute("data-card", "request");

  const resultText = result ? JSON.stringify(result, null, 2) : "null";
  const srcLabel = prettySource(source);

  wrap.innerHTML = `
    <div class="bg-blue-50 text-gray-800 px-4 py-3 rounded-xl max-w-[80%]">
      <div class="text-xs text-gray-500 mb-1">Ngu·ªìn: <span class="font-medium">${srcLabel}</span></div>
      <div class="font-semibold mb-1">SQL ƒë∆∞·ª£c t·∫°o:</div>
      <pre class="text-xs whitespace-pre-wrap bg-white border rounded p-2 max-h-64 overflow-y-auto">${(sql||"").replace(/</g,"&lt;")}</pre>
      <div class="font-semibold mt-3 mb-1">Result:</div>
      <pre class="text-xs whitespace-pre-wrap bg-white border rounded p-2 max-h-64 overflow-y-auto">${resultText.replace(/</g,"&lt;")}</pre>
      <div class="mt-2 flex flex-wrap gap-2">
        <button class="px-3 py-1 rounded bg-blue-600 text-white"
                data-action="approve-save" 
                data-question="${encodeURIComponent(question)}"
                data-sql="${encodeURIComponent(sql)}">L∆∞u</button>
        <button class="px-3 py-1 rounded bg-gray-500 text-white"
                data-action="approve-skip">B·ªè qua</button>
        <button class="px-3 py-1 rounded bg-amber-600 text-white"
                data-action="refine-open"
                data-question="${encodeURIComponent(question)}"
                data-sql="${encodeURIComponent(sql)}">T·∫°o l·∫°i (ch∆∞a ƒë√∫ng)</button>
      </div>
    </div>`;
  chatBox.appendChild(wrap);
  chatBox.scrollTop = chatBox.scrollHeight;
}


  // Form refine (nh·∫≠p feedback)
  function appendRefineForm(question, sql) {
  const wrap = document.createElement("div");
  wrap.className = "flex justify-start";
  wrap.setAttribute("data-card", "request");  // üîñ
  wrap.innerHTML = `
    <div class="bg-amber-50 text-gray-900 px-4 py-3 rounded-xl max-w-[80%]">
      <div class="mb-2 font-semibold">M√¥ t·∫£ ng·∫Øn l√Ω do ch∆∞a ƒë√∫ng (v√≠ d·ª•: "thi·∫øu join brands", "l·ªçc sai ƒëi·ªÅu ki·ªán ng√†y"):</div>
      <textarea class="w-full border rounded p-2 text-sm" rows="3" data-role="refine-feedback"></textarea>

      <div class="mt-3 mb-2 font-semibold">Chi ti·∫øt b·ªï sung / r√†ng bu·ªôc mong mu·ªën:</div>
      <textarea class="w-full border rounded p-2 text-sm" rows="4" data-role="refine-extra"
        placeholder="M√¥ t·∫£ th√™m b·∫°n mu·ªën s·ª≠a g√¨: th√™m c·ªôt n√†o, group theo g√¨, ƒëi·ªÅu ki·ªán ng√†y/brand, v√≠ d·ª• k·∫øt qu·∫£ mong mu·ªën..."></textarea>

      <div class="mt-3 flex gap-2">
        <button class="px-3 py-1 rounded bg-amber-700 text-white"
                data-action="refine-submit"
                data-question="${encodeURIComponent(question)}"
                data-sql="${encodeURIComponent(sql)}">T·∫°o l·∫°i</button>
        <button class="px-3 py-1 rounded bg-gray-400 text-white"
                data-action="refine-cancel">H·ªßy</button>
      </div>
    </div>`;
  chatBox.appendChild(wrap);
  chatBox.scrollTop = chatBox.scrollHeight;
}

  // Delegation: 1 listener cho m·ªçi n√∫t trong chatBox
  chatBox.addEventListener("click", async (e) => {
    const btn = e.target.closest("[data-action]");
    if (!btn) return;

    const action = btn.dataset.action;
    // L·∫•y data k√®m theo (n·∫øu c√≥)
    const question = btn.dataset.question ? decodeURIComponent(btn.dataset.question) : null;
    const sql = btn.dataset.sql ? decodeURIComponent(btn.dataset.sql) : null;

    try {
      if (action === "confirm-yes") {
        appendMsg("c√≥", "user");
        await sendRaw("c√≥");
      } else if (action === "confirm-no") {
        appendMsg("kh√¥ng", "user");
        await sendRaw("kh√¥ng");
      } else if (action === "approve-save") {
        const res = await fetch("/check", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ question, sql, approve: true })
        });
        const data = await res.json();
        appendMsg(data.message || "ƒê√£ l∆∞u.", "bot");
      } else if (action === "approve-skip") {
        const res = await fetch("/check", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ question, sql, approve: false })
        });
        const data = await res.json();
        appendMsg(data.message || "ƒê√£ b·ªè qua.", "bot");
      } else if (action === "refine-open") {
        appendRefineForm(question, sql);
      } else if (action === "refine-cancel") {
        appendMsg("ƒê√£ h·ªßy t·∫°o l·∫°i.", "bot");
      } else if (action === "refine-submit") {
        const container = btn.closest("div").parentElement;
        const feedback = container.querySelector('[data-role="refine-feedback"]').value.trim();
        const extra_context = container.querySelector('[data-role="refine-extra"]').value.trim();

        appendMsg("T·∫°o l·∫°i SQL...", "bot");
        const res = await fetch("/refine", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ question, sql, feedback, extra_context })
        });
        const data = await res.json();
        appendMsg(data.response || data.error || "(no response)", "bot");
        if (data.sql || data.response) {
          const sqlNew = data.sql || data.response;
          const result = ("result" in data) ? data.result : null;
          const source = data.source || "refined";   // <-- truy·ªÅn ngu·ªìn refine
          appendApprove(question, sqlNew, result, source);
        }
      }
    } catch (err) {
      appendMsg("L·ªói: " + err.message, "bot");
    }
  });

  // ---------- Upload schema (multi-file) ----------
  document.getElementById('btnUpload').addEventListener('click', async () => {
    const fileInput = document.getElementById('schemaFile');
    const status = document.getElementById('uploadStatus');
    const preview = document.getElementById('schemaPreview');

    if (!fileInput.files || fileInput.files.length === 0) {
      status.textContent = 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 file .txt/.sql/.csv/.json/.jsonl tr∆∞·ªõc.';
      status.className = 'text-sm text-red-600';
      return;
    }

    const fd = new FormData();
    for (const f of fileInput.files) fd.append('file', f);

    status.textContent = 'ƒêang t·∫£i v√† x·ª≠ l√Ω file...';
    status.className = 'text-sm text-gray-600';

    try {
      const res = await fetch('/upload-schema', { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Upload th·∫•t b·∫°i');

      status.textContent = data.message || 'ƒê√£ c·∫≠p nh·∫≠t schema.';
      status.className = 'text-sm text-green-700';
      preview.textContent = data.schema_text || '';
    } catch (e) {
      status.textContent = 'L·ªói: ' + e.message;
      status.className = 'text-sm text-red-600';
    }
  });

  // ---------- Xem schema hi·ªán t·∫°i ----------
  document.getElementById('btnShowSchema').addEventListener('click', async () => {
    const preview = document.getElementById('schemaPreview');
    try {
      const res = await fetch('/schema');
      const data = await res.json();

      const files = (data.files || []).join(', ');
      const tables = (data.tables || []).join(', ');
      const idMap = data.id_map || {};
      const mapText = Object.keys(idMap).length
        ? Object.entries(idMap).map(([tbl, id]) => `${id} = ${tbl}`).join(', ')
        : '';

      const header =
        `üìÅ Files: ${files || '(ch∆∞a c√≥)'}\n` +
        `üóÇ  Tables: ${tables || '(ch∆∞a c√≥)'}\n` +
        (mapText ? `üî¢ Mapping: ${mapText}\n` : '') +
        (data.memories_filename ? `üìù Memories file: ${data.memories_filename}\n` : '') +
        (data.active_primary_table ? `‚≠ê Active table: ${data.active_primary_table}\n` : '');

      preview.textContent = header + '\n' + (data.schema_text || '');
    } catch (e) {
      preview.textContent = '(Kh√¥ng l·∫•y ƒë∆∞·ª£c schema) ' + e.message;
    }
  });

  // ---------- Chat ----------
  let sending = false;

  document.getElementById('btnSend').addEventListener('click', sendMsg);
  document.getElementById('input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); sendMsg(); }
  });

  async function sendMsg() {
    if (sending) return;
    const msg = inputEl.value.trim();
    if (!msg) return;

    sending = true;
    btnSend.disabled = true;

    appendMsg(msg, "user");
    inputEl.value = "";

    try {
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg })
      });
      const data = await res.json();
      handleChatResponse(data);
    } catch (e) {
      appendMsg("L·ªói m·∫°ng: " + e.message, "bot");
    } finally {
      sending = false;
      btnSend.disabled = false;
    }
  }

  async function sendRaw(text) {
    // g·ª≠i "c√≥/kh√¥ng" cho flow pending_question
    try {
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });
      const data = await res.json();
      handleChatResponse(data);
    } catch (e) {
      appendMsg("L·ªói m·∫°ng: " + e.message, "bot");
    }
  }

  function handleChatResponse(data) {
  if (data.needs_confirmation) {
    appendConfirm(data.question);
    return;
  }
  appendMsg(data.response || data.error || "(no response)", "bot");

  if (data.needs_check && data.question) {
    const sql = data.sql || extractSQLFromText(data.response) || "";
    const result = ("result" in data) ? data.result : null;
    const source = data.source || "";
    appendApprove(data.question, sql, result, source);
  }
}

function appendRefineForm(question, sql) {
    const wrap = document.createElement("div");
    wrap.className = "flex justify-start";
    wrap.innerHTML = `
      <div class="bg-amber-50 text-gray-900 px-4 py-3 rounded-xl max-w-[80%]">
        <div class="mb-2 font-semibold">M√¥ t·∫£ ng·∫Øn l√Ω do ch∆∞a ƒë√∫ng (v√≠ d·ª•: "thi·∫øu join brands", "l·ªçc sai ƒëi·ªÅu ki·ªán ng√†y"):</div>
        <textarea class="w-full border rounded p-2 text-sm" rows="3" data-role="refine-feedback"></textarea>

        <div class="mt-3 mb-2 font-semibold">Chi ti·∫øt b·ªï sung / r√†ng bu·ªôc mong mu·ªën:</div>
        <textarea class="w-full border rounded p-2 text-sm" rows="4" data-role="refine-extra"
          placeholder="M√¥ t·∫£ th√™m b·∫°n mu·ªën s·ª≠a g√¨: th√™m c·ªôt n√†o, group theo g√¨, ƒëi·ªÅu ki·ªán ng√†y/brand, v√≠ d·ª• k·∫øt qu·∫£ mong mu·ªën..."></textarea>

        <div class="mt-3 flex gap-2">
          <button class="px-3 py-1 rounded bg-amber-700 text-white"
                  data-action="refine-submit"
                  data-question="${encodeURIComponent(question)}"
                  data-sql="${encodeURIComponent(sql)}">T·∫°o l·∫°i</button>
          <button class="px-3 py-1 rounded bg-gray-400 text-white"
                  data-action="refine-cancel">H·ªßy</button>
        </div>
      </div>`;
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function clearChat() {
  chatBox.innerHTML = "";
  }

  function closeAllRequestCards() {
    document.querySelectorAll('[data-card="request"]').forEach(el => el.remove());
  }

  // Tick l√† x√≥a chat ngay r·ªìi t·ª± b·ªè tick
  const clearTick = document.getElementById("clearChatTick");
  if (clearTick) {
    clearTick.addEventListener("change", (e) => {
      if (e.target.checked) {
        clearChat();
        e.target.checked = false;
      }
    });
  }

  // Tick l√† t·ª± ƒë√≥ng c√°c th·∫ª y√™u c·∫ßu (n·∫øu c√≥)
function prettySource(src) {
  if (!src) return "Kh√¥ng r√µ";
  const s = src.toLowerCase();
  if (s === "sqlcoder") return "SQLCoder-7B-2";
  if (s === "grok") return "Grok-3";
  if (s === "openai") return "GPT-4o-mini";
  if (s === "deepseek") return "DeepSeek";
  if (s === "refined") return "Refine";
  if (s === "dataset") return "Dataset";
  if (s === "refined_sqlcoder") return "SQLCoder-7B-2 (Refine)";
  return src;
}

// T·ª± ƒë√≥ng th·∫ª y√™u c·∫ßu
function extractSQLFromText(txt) {
  if (!txt) return "";
  // ∆Øu ti√™n n·ªôi dung trong ```
  const fence = txt.match(/```(?:sql)?\s*([\s\S]*?)```/i);
  let t = fence ? fence[1] : txt;

  // C·∫Øt ph·∫ßn Status/Result n·∫øu c√≥
  t = t.replace(/^\s*Status\s*:.+$/gim, "")
       .replace(/^\s*Result\s*:.+$/gim, "");

  // B·ªè nh√£n
  t = t.replace(/^\s*(sql\s*ƒë∆∞·ª£c\s*t·∫°o|sql|query)\s*[:\-]*/i, "").trim();

  // L·∫•y t·ª´ SELECT... tr·ªü ƒëi
  const m = t.match(/(select|insert|update|delete)[\s\S]*$/i);
  return (m ? m[0] : t).trim();
}

// T·ª± ƒë√≥ng th·∫ª y√™u c·∫ßu n·∫øu tick
document.getElementById('btnShowPretrain').addEventListener('click', async () => {
  const preview = document.getElementById('schemaPreview');
  if (!preview) return;
  preview.innerHTML = "‚è≥ ƒêang t·∫£i pretrain...";

  try {
    // Try reading human-readable pretrain file first
    const resFile = await fetch('/pretrain-file');
    const fileJson = await resFile.json();
    if (fileJson && fileJson.exists && fileJson.content) {
      // If file exists, parse it maybe as plain text but we prefer the structured jsonl via report
      // We'll show the plain text file (so it matches your requested format)
      preview.innerHTML = `<pre style="white-space:pre-wrap; background:#fafafa; padding:12px; border-radius:8px;">${escapeHtml(fileJson.content)}</pre>`;
      return;
    }

    // Fallback to structured report (JSON)
    const res = await fetch('/pretrain-report?max_lines=100');
    const data = await res.json();
    if (!data || !data.items || data.items.length === 0) {
      preview.innerHTML = "(kh√¥ng c√≥ m·ª•c pretrain)";
      return;
    }

    // build HTML from items: newest first
    const items = data.items;
    let html = `<div style="font-weight:700; margin-bottom:8px;">Pretrain items: ${data.count}</div>`;
    for (let i = 0; i < items.length; i++) {
      const it = items[i];
      html += renderPretrainItem(it, i+1);
    }
    preview.innerHTML = html;

  } catch (err) {
    preview.innerHTML = "L·ªói khi t·∫£i pretrain: " + escapeHtml(err && err.message ? err.message : String(err));
  }
});

// Pretrain th√™m
document.getElementById('btnPretrainMore').addEventListener('click', async () => {
  const roundsStr = window.prompt("B·∫°n mu·ªën sinh th√™m bao nhi√™u Q&A?", "10");
  const rounds = parseInt(roundsStr || "0", 10);
  if (!rounds) return;

  // ch·ªçn strategy ƒë∆°n gi·∫£n: cascade (∆∞u ti√™n SQLCoder, fallback Gemini)
  const strategy = "cascade";

  // b√°o ƒëang ch·∫°y
  const preview = document.getElementById('schemaPreview');
  if (preview) preview.textContent = "‚è≥ ƒêang pretrain th√™m...";

  try {
    const res = await fetch('/pretrain', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ rounds, strategy })
    });
    const data = await res.json();

    // t√≥m t·∫Øt
    const msg = `ƒê√£ pretrain: tried=${data.tried||0}, saved=${data.saved||0}\n` +
                (data.log_file ? `Log: ${data.log_file}\n` : "");
    // hi·ªÉn th·ªã 5 m·ª•c g·∫ßn nh·∫•t
    const items = (data.preview || []).map((it,i) =>
      `#${i+1}\nQ: ${it.question}\nSQL: ${it.sql || "(NO_SQL)"}\nStatus: ${it.exec_status||""}\nSaved: ${it.saved?"‚úì":"√ó"}\nSource: ${it.source||""}`
    ).join("\n\n");
    if (preview) preview.textContent = msg + "\n\n" + (items || "(kh√¥ng c√≥ m·ª•c xem nhanh)");

    // c·∫≠p nh·∫≠t report m·ªõi nh·∫•t ƒë·ªÉ b·∫°n xem d√†i h∆°n
    // (kh√¥ng b·∫Øt bu·ªôc)
    const rep = await fetch('/pretrain-report').then(r=>r.json());
    console.log(rep);

  } catch (e) {
    if (preview) preview.textContent = "L·ªói g·ªçi /pretrain: " + e.message;
  }
});



</script>
</body>
</html>
