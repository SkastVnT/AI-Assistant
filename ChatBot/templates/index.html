<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ChatBot Assistant</title>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background 0.3s ease;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .main-wrapper {
            display: flex;
            gap: 0;
            width: 100%;
            max-width: 1400px;
            height: 90vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            border-radius: 20px 0 0 20px;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        body.dark-mode .sidebar {
            background: #1e1e1e;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        body.dark-mode .sidebar-header {
            border-bottom-color: #444;
        }
        
        .sidebar-header h3 {
            font-size: 16px;
            margin: 0;
            color: #333;
        }
        
        body.dark-mode .sidebar-header h3 {
            color: #e0e0e0;
        }
        
        .new-chat-btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .chat-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        body.dark-mode .chat-item {
            background: #2a2a2a;
        }
        
        .chat-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        body.dark-mode .chat-item:hover {
            background: #333;
        }
        
        .chat-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .chat-item-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .chat-item-preview {
            font-size: 12px;
            opacity: 0.7;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .chat-item-time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 4px;
        }
        
        .chat-item-actions {
            display: none;
            gap: 5px;
            margin-top: 8px;
        }
        
        .chat-item:hover .chat-item-actions {
            display: flex;
        }
        
        .chat-item-btn {
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: inherit;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .chat-item-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .sidebar-toggle {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        body.dark-mode .sidebar-toggle {
            background: #1e1e1e;
            border-color: #ffd700;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 999;
                border-radius: 0;
            }
            
            .sidebar.show {
                left: 0;
            }
            
            .sidebar-toggle {
                display: flex;
            }
        }
        
        
        .container {
            width: 100%;
            background: white;
            border-radius: 0 20px 20px 0;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        body.dark-mode .container {
            background: #1e1e1e;
            color: #e0e0e0;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            transition: background 0.3s ease;
        }
        
        body.dark-mode .controls {
            background: #2a2a2a;
            border-bottom: 1px solid #444;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group label {
            font-weight: 600;
            margin-right: 10px;
            display: flex;
            align-items: center;
        }
        
        select, button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        body.dark-mode select,
        body.dark-mode button {
            background: #333;
            color: #e0e0e0;
            border-color: #555;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        /* Dark mode toggle button */
        .dark-mode-toggle {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 8px 15px;
            font-size: 18px;
        }
        
        body.dark-mode .dark-mode-toggle {
            border-color: #ffd700;
            color: #ffd700;
        }
        
        .dark-mode-toggle:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        /* Download button */
        .download-btn {
            background: transparent;
            border: 2px solid #28a745;
            color: #28a745;
            padding: 8px 15px;
            font-size: 14px;
        }
        
        body.dark-mode .download-btn {
            border-color: #4ade80;
            color: #4ade80;
        }
        
        .download-btn:hover {
            background: rgba(40, 167, 69, 0.1);
            transform: translateY(-2px);
        }
        
        body.dark-mode .download-btn:hover {
            background: rgba(74, 222, 128, 0.1);
        }
        
        /* Checkbox styling */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        body.dark-mode .checkbox-container {
            background: #333;
            border-color: #555;
        }
        
        .checkbox-container:hover {
            border-color: #667eea;
        }
        
        .checkbox-container input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }
        
        .checkbox-container label {
            cursor: pointer;
            margin: 0;
            font-size: 14px;
        }
        
        .chat-container {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            transition: background 0.3s ease;
        }
        
        body.dark-mode .chat-container {
            background: #252525;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message.assistant {
            justify-content: flex-start;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 15px;
            position: relative;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.assistant .message-content {
            background: white;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-bottom-left-radius: 5px;
        }
        
        body.dark-mode .message.assistant .message-content {
            background: #333;
            color: #e0e0e0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        /* Markdown Styling */
        .message-content strong {
            font-weight: 700;
            color: #667eea;
        }
        
        .message-content em {
            font-style: italic;
        }
        
        .message-content u {
            text-decoration: underline;
        }
        
        .message-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .message-content pre {
            background: #282c34;
            color: #abb2bf;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .message-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }
        
        .message-content ul, .message-content ol {
            margin-left: 20px;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        
        .message-content li {
            margin: 4px 0;
        }
        
        .message-content p {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .message-content h1, .message-content h2, .message-content h3 {
            margin-top: 12px;
            margin-bottom: 8px;
            color: #667eea;
        }
        
        .message-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 12px;
            margin: 10px 0;
            color: #666;
            font-style: italic;
        }
        
        .message-content hr {
            border: none;
            border-top: 2px solid #e9ecef;
            margin: 15px 0;
        }
        
        .message-content a {
            color: #667eea;
            text-decoration: none;
        }
        
        .message-content a:hover {
            text-decoration: underline;
        }
        
        /* Copy table button */
        .copy-table-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        body.dark-mode .copy-table-btn {
            background: #5568d3;
        }
        
        .copy-table-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        body.dark-mode .copy-table-btn:hover {
            background: #667eea;
        }
        
        .copy-table-btn.copied {
            background: #28a745;
        }
        
        body.dark-mode .copy-table-btn.copied {
            background: #4ade80;
        }
        
        /* Copy message button */
        .copy-message-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 5px 12px;
            background: transparent;
            color: #667eea;
            border: 1px solid #667eea;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        body.dark-mode .copy-message-btn {
            color: #ffd700;
            border-color: #ffd700;
        }
        
        .copy-message-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }
        
        body.dark-mode .copy-message-btn:hover {
            background: #ffd700;
            color: #1a1a2e;
        }
        
        .copy-message-btn.copied {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        body.dark-mode .copy-message-btn.copied {
            background: #4ade80;
            border-color: #4ade80;
        }
        
        /* Table styling in dark mode */
        body.dark-mode .message-content table {
            border-color: #555;
        }
        
        body.dark-mode .message-content th,
        body.dark-mode .message-content td {
            border-color: #555;
        }
        
        body.dark-mode .message-content th {
            background: #333;
        }
        
        body.dark-mode .message-content tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .message-info {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .message-timestamp {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 3px;
            font-style: italic;
        }
        
        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #dee2e6;
            transition: background 0.3s ease;
        }
        
        body.dark-mode .input-container {
            background: #1e1e1e;
            border-top: 1px solid #444;
        }
        
        .input-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .tool-btn {
            padding: 6px 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tool-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
        }
        
        .tool-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            padding: 6px 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        body.dark-mode .file-label {
            background: #333;
            color: #e0e0e0;
            border-color: #555;
        }
        
        .file-label:hover {
            background: #e9ecef;
        }
        
        body.dark-mode .file-label:hover {
            background: #444;
        }
        
        .file-name {
            font-size: 12px;
            color: #666;
            margin-left: 10px;
        }
        
        body.dark-mode .file-name {
            color: #aaa;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        #messageInput {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            font-size: 14px;
            transition: all 0.3s;
            resize: vertical;
            min-height: 45px;
            max-height: 200px;
            font-family: inherit;
            background: white;
        }
        
        body.dark-mode #messageInput {
            background: #333;
            color: #e0e0e0;
            border-color: #555;
        }
        
        #messageInput:focus {
            outline: none;
            border-color: #667eea;
        }
        
        #sendBtn {
            padding: 12px 30px;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #sendBtn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Image Generation Button */
        .image-gen-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .image-gen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }
        
        /* Image Generation Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }
        
        body.dark-mode .modal-content {
            background: #2a2a2a;
            color: #e0e0e0;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        body.dark-mode .modal-header {
            border-bottom-color: #444;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #667eea;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: #f5576c;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        body.dark-mode .form-group label {
            color: #e0e0e0;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode .form-group textarea {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .sd-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .sd-status.online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .sd-status.offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        body.dark-mode .sd-status.online {
            background: #1e4620;
            color: #8fff8f;
            border-color: #2d5f2f;
        }
        
        body.dark-mode .sd-status.offline {
            background: #4a1f1f;
            color: #ff8f8f;
            border-color: #5f2d2d;
        }
        
        .generated-image {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .image-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .image-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .copy-to-chat-btn {
            background: #28a745;
            color: white;
        }
        
        .copy-to-chat-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .download-image-btn {
            background: #17a2b8;
            color: white;
        }
        
        .download-image-btn:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Toggle (Mobile) -->
    <div class="sidebar-toggle" id="sidebarToggle">
        ‚ò∞
    </div>
    
    <div class="main-wrapper">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>üí¨ L·ªãch s·ª≠ Chat</h3>
                <button class="new-chat-btn" id="newChatBtn">+ M·ªõi</button>
            </div>
            <div style="padding: 10px; font-size: 11px; color: #888; border-bottom: 1px solid #333;">
                <span id="storageInfo">ƒêang t√≠nh...</span>
            </div>
            <div class="chat-list" id="chatList">
                <!-- Chat items will be dynamically added here -->
            </div>
        </div>
        
        <!-- Main Chat Container -->
        <div class="container">
        <div class="header">
            <h1>ü§ñ AI ChatBot Assistant</h1>
            <p>H·ªó tr·ª£ t√¢m l√Ω, t√¢m s·ª± v√† gi·∫£i ph√°p ƒë·ªùi s·ªëng</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>
                    Model:
                    <select id="modelSelect">
                        <option value="gemini">Gemini (Google) - FREE</option>
                        <option value="openai">GPT-4o-mini (OpenAI)</option>
                        <option value="deepseek">DeepSeek (R·∫ª nh·∫•t)</option>
                    </select>
                </label>
                
                <label>
                    Ch·∫ø ƒë·ªô:
                    <select id="contextSelect">
                        <option value="casual">Tr√≤ chuy·ªán vui v·∫ª</option>
                        <option value="psychological">T√¢m l√Ω - T√¢m s·ª±</option>
                        <option value="lifestyle">Gi·∫£i ph√°p ƒë·ªùi s·ªëng</option>
                        <option value="programming">üíª H·ªó tr·ª£ l·∫≠p tr√¨nh</option>
                    </select>
                </label>
                
                <div class="checkbox-container" id="deepThinkingContainer">
                    <input type="checkbox" id="deepThinkingCheck">
                    <label for="deepThinkingCheck">üß† Suy lu·∫≠n s√¢u</label>
                </div>
                
                <button class="download-btn" id="downloadBtn" title="T·∫£i xu·ªëng l·ªãch s·ª≠ chat">
                    üì• T·∫£i chat
                </button>
                <button class="image-gen-btn" id="imageGenBtn" title="T·∫°o ·∫£nh b·∫±ng AI">
                    üé® T·∫°o ·∫£nh
                </button>
                <button class="dark-mode-toggle" id="darkModeBtn" title="Toggle Dark Mode">üåô</button>
                <button id="clearBtn">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>
            </div>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="message assistant">
                <div class="message-content">
                    <div>Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI c·ªßa b·∫°n. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay? üòä</div>
                    <div class="message-info">Gemini ‚Ä¢ Tr√≤ chuy·ªán vui v·∫ª</div>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <span>ƒêang suy nghƒ©...</span>
        </div>
        
        <div class="input-container">
            <div class="input-tools">
                <button class="tool-btn" id="googleSearchBtn" title="T√¨m ki·∫øm Google">
                    üîç Google Search
                </button>
                <button class="tool-btn" id="githubBtn" title="K·∫øt n·ªëi GitHub">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    GitHub
                </button>
                <button class="tool-btn" id="imageGenToolBtn" title="T·∫°o ·∫£nh t·ª´ m√¥ t·∫£">
                    üé® T·∫°o ·∫£nh
                </button>
                <label class="file-label">
                    üìé Upload File
                    <input type="file" class="file-input" id="fileInput" accept=".txt,.pdf,.doc,.docx,.json">
                </label>
                <span class="file-name" id="fileName"></span>
            </div>
            <div class="input-group">
                <textarea 
                    id="messageInput" 
                    placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n... (Shift+Enter ƒë·ªÉ xu·ªëng d√≤ng)"
                    rows="1"
                ></textarea>
                <button id="sendBtn">G·ª≠i</button>
            </div>
        </div>
        </div> <!-- Close container -->
    </div> <!-- Close main-wrapper -->
    
    <script>
        // DOM elements - DECLARE FIRST
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearBtn = document.getElementById('clearBtn');
        const modelSelect = document.getElementById('modelSelect');
        const contextSelect = document.getElementById('contextSelect');
        const loading = document.getElementById('loading');
        const googleSearchBtn = document.getElementById('googleSearchBtn');
        const githubBtn = document.getElementById('githubBtn');
        const imageGenToolBtn = document.getElementById('imageGenToolBtn');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const deepThinkingCheck = document.getElementById('deepThinkingCheck');
        const darkModeBtn = document.getElementById('darkModeBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        
        let activeTools = new Set();
        let uploadedFile = null;
        let conversationActive = false;
        let chatHistory = []; // Store full chat history for download
        
        // Chat Session Management
        let currentChatId = null;
        let chatSessions = {};
        
        class ChatSession {
            constructor(id) {
                this.id = id;
                this.title = 'Cu·ªôc tr√≤ chuy·ªán m·ªõi';
                this.messages = [];
                this.createdAt = new Date();
                this.updatedAt = new Date();
            }
        }
        
        // Load sessions from localStorage
        function loadSessions() {
            const saved = localStorage.getItem('chatSessions');
            if (saved) {
                const parsed = JSON.parse(saved);
                chatSessions = {};
                Object.keys(parsed).forEach(id => {
                    const session = parsed[id];
                    chatSessions[id] = session;
                    chatSessions[id].createdAt = new Date(session.createdAt);
                    chatSessions[id].updatedAt = new Date(session.updatedAt);
                });
            }
            
            // If no sessions exist, create first one
            if (Object.keys(chatSessions).length === 0) {
                newChat();
            } else {
                // Load the most recent chat
                const sortedIds = Object.keys(chatSessions).sort((a, b) => 
                    chatSessions[b].updatedAt - chatSessions[a].updatedAt
                );
                currentChatId = sortedIds[0];
                loadChat(currentChatId);
            }
            
            renderChatList();
        }
        
        // Save sessions to localStorage
        function saveSessions() {
            try {
                const sessionsData = JSON.stringify(chatSessions);
                const sizeInMB = (new Blob([sessionsData]).size / 1024 / 1024).toFixed(2);
                
                console.log(`[STORAGE] Saving ${Object.keys(chatSessions).length} sessions, size: ${sizeInMB}MB`);
                
                localStorage.setItem('chatSessions', sessionsData);
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    console.error('[STORAGE] Quota exceeded! Cleaning up old sessions...');
                    
                    // Show error to user
                    alert('‚ö†Ô∏è B·ªô nh·ªõ ƒë·∫ßy!\n\nƒêang t·ª± ƒë·ªông x√≥a c√°c chat c≈© ƒë·ªÉ gi·∫£i ph√≥ng dung l∆∞·ª£ng...');
                    
                    // Keep only the 5 most recent sessions
                    const sortedIds = Object.keys(chatSessions).sort((a, b) => 
                        chatSessions[b].updatedAt - chatSessions[a].updatedAt
                    );
                    
                    const idsToKeep = sortedIds.slice(0, 5);
                    const newSessions = {};
                    
                    idsToKeep.forEach(id => {
                        newSessions[id] = chatSessions[id];
                    });
                    
                    chatSessions = newSessions;
                    
                    // Try saving again
                    try {
                        localStorage.setItem('chatSessions', JSON.stringify(chatSessions));
                        console.log(`[STORAGE] Successfully cleaned up. Kept ${idsToKeep.length} sessions.`);
                        renderChatList();
                        
                        // If current chat was deleted, switch to most recent
                        if (!chatSessions[currentChatId]) {
                            switchChat(idsToKeep[0]);
                        }
                    } catch (e2) {
                        console.error('[STORAGE] Still failed after cleanup:', e2);
                        alert('‚ùå Kh√¥ng th·ªÉ l∆∞u chat.\n\nVui l√≤ng:\n1. Export chat quan tr·ªçng\n2. X√≥a b·ªõt chat c≈©\n3. Ho·∫∑c clear localStorage');
                    }
                } else {
                    console.error('[STORAGE] Error saving sessions:', e);
                }
            }
            // Update storage display after save
            updateStorageDisplay();
        }
        
        // Update storage usage display
        function updateStorageDisplay() {
            try {
                const sessionsData = JSON.stringify(chatSessions);
                const sizeInMB = (new Blob([sessionsData]).size / 1024 / 1024).toFixed(2);
                const maxSizeMB = 200; // Increased limit for 4K images
                const percentage = ((sizeInMB / maxSizeMB) * 100).toFixed(0);
                
                const storageInfo = document.getElementById('storageInfo');
                const color = percentage > 80 ? '#ff4444' : percentage > 50 ? '#ffa500' : '#4CAF50';
                
                storageInfo.innerHTML = `
                    <span style="color: ${color};">üìä L∆∞u tr·ªØ: ${sizeInMB}MB / ${maxSizeMB}MB (${percentage}%)</span>
                    <button onclick="manualCleanup()" style="
                        margin-left: 10px;
                        padding: 2px 6px;
                        font-size: 10px;
                        background: #444;
                        border: 1px solid #666;
                        border-radius: 3px;
                        color: #fff;
                        cursor: pointer;
                    " title="X√≥a c√°c chat c≈© (gi·ªØ l·∫°i 5 g·∫ßn nh·∫•t)">üóëÔ∏è D·ªçn d·∫πp</button>
                `;
            } catch (e) {
                console.error('[STORAGE] Error updating storage display:', e);
            }
        }
        
        // Manual cleanup function
        function manualCleanup() {
            const sessionCount = Object.keys(chatSessions).length;
            if (sessionCount <= 5) {
                alert('Ch·ªâ c√≤n ' + sessionCount + ' chat, kh√¥ng c·∫ßn d·ªçn d·∫πp.');
                return;
            }
            
            if (confirm(`X√≥a c√°c chat c≈© v√† ch·ªâ gi·ªØ l·∫°i 5 chat g·∫ßn nh·∫•t?\nHi·ªán t·∫°i c√≥ ${sessionCount} chat.`)) {
                const sortedSessions = Object.entries(chatSessions)
                    .sort((a, b) => new Date(b[1].updatedAt) - new Date(a[1].updatedAt))
                    .slice(0, 5);
                
                const oldCount = sessionCount;
                chatSessions = Object.fromEntries(sortedSessions);
                
                // Update current chat if it was deleted
                if (!chatSessions[currentChatId]) {
                    currentChatId = sortedSessions[0][0];
                    loadChat(currentChatId);
                }
                
                saveSessions(); // This will also update storage display
                renderChatList();
                
                alert(`‚úÖ ƒê√£ x√≥a ${oldCount - 5} chat c≈©!\nGi·ªØ l·∫°i 5 chat g·∫ßn nh·∫•t.`);
            }
        }
        
        // Create new chat session
        function newChat() {
            // Save current chat before creating new one
            if (currentChatId && chatSessions[currentChatId]) {
                chatSessions[currentChatId].messages = Array.from(chatContainer.children).map(el => el.outerHTML);
                chatSessions[currentChatId].updatedAt = new Date();
            }
            
            const id = 'chat_' + Date.now();
            const session = new ChatSession(id);
            chatSessions[id] = session;
            currentChatId = id;
            
            // Clear chat container - start clean without welcome message
            chatContainer.innerHTML = '';
            
            chatHistory = [];
            saveSessions();
            renderChatList();
        }
        
        // Switch to existing chat
        function switchChat(chatId) {
            if (chatId === currentChatId) return;
            
            // Save current chat before switching
            if (currentChatId && chatSessions[currentChatId]) {
                chatSessions[currentChatId].messages = Array.from(chatContainer.children).map(el => el.outerHTML);
                chatSessions[currentChatId].updatedAt = new Date();
            }
            
            currentChatId = chatId;
            loadChat(chatId);
            saveSessions();
            renderChatList();
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('show');
            }
        }
        
        // Load chat from session
        function loadChat(chatId) {
            const session = chatSessions[chatId];
            if (!session) return;
            
            if (session.messages.length > 0) {
                chatContainer.innerHTML = session.messages.join('');
            } else {
                // Start with empty chat
                chatContainer.innerHTML = '';
            }
            
            // Rebuild chatHistory for download
            chatHistory = [];
            Array.from(chatContainer.children).forEach(msgEl => {
                const isUser = msgEl.classList.contains('user');
                const content = msgEl.querySelector('.message-content > div:first-child')?.textContent || '';
                chatHistory.push({
                    role: isUser ? 'user' : 'assistant',
                    content: content
                });
            });
        }
        
        // Delete chat session
        function deleteChat(chatId, event) {
            event.stopPropagation();
            
            if (Object.keys(chatSessions).length === 1) {
                alert('Kh√¥ng th·ªÉ x√≥a cu·ªôc tr√≤ chuy·ªán cu·ªëi c√πng!');
                return;
            }
            
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a cu·ªôc tr√≤ chuy·ªán n√†y?')) {
                return;
            }
            
            delete chatSessions[chatId];
            
            // If deleting current chat, switch to another
            if (chatId === currentChatId) {
                const remainingIds = Object.keys(chatSessions);
                if (remainingIds.length > 0) {
                    switchChat(remainingIds[0]);
                } else {
                    newChat();
                }
            }
            
            saveSessions();
            renderChatList();
        }
        
        // Generate title using Gemini
        async function generateTitle(firstMessage) {
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Generate a concise 3-5 word Vietnamese title for this conversation. Only return the title, nothing else: "${firstMessage.substring(0, 100)}"`,
                        model: 'gemini',
                        context: 'casual',
                        tools: [],
                        deep_thinking: false
                    })
                });
                
                const data = await response.json();
                if (data.response) {
                    return data.response.trim().replace(/['"]/g, '');
                }
            } catch (error) {
                console.error('Failed to generate title:', error);
            }
            
            // Fallback: use first few words
            return firstMessage.substring(0, 30) + (firstMessage.length > 30 ? '...' : '');
        }
        
        // Render chat list in sidebar
        function renderChatList() {
            const chatList = document.getElementById('chatList');
            const sortedChats = Object.keys(chatSessions).sort((a, b) => 
                chatSessions[b].updatedAt - chatSessions[a].updatedAt
            );
            
            chatList.innerHTML = sortedChats.map(id => {
                const session = chatSessions[id];
                const isActive = id === currentChatId;
                const preview = session.messages.length > 0 
                    ? (session.messages[1] || session.messages[0]).replace(/<[^>]*>/g, '').substring(0, 50) + '...'
                    : 'Ch∆∞a c√≥ tin nh·∫Øn';
                
                return `
                    <div class="chat-item ${isActive ? 'active' : ''}" onclick="switchChat('${id}')">
                        <div class="chat-item-title">${session.title}</div>
                        <div class="chat-item-preview">${preview}</div>
                        <div class="chat-item-footer">
                            <span class="chat-item-time">${formatTimestamp(session.updatedAt)}</span>
                            <button class="chat-delete-btn" onclick="deleteChat('${id}', event)" title="X√≥a">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Sidebar toggle for mobile
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('show');
        });
        
        document.getElementById('newChatBtn').addEventListener('click', newChat);
        
        // Initialize sessions on page load
        loadSessions();
        
        // Update storage display on page load
        updateStorageDisplay();
        
        // Dark Mode
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            darkModeBtn.textContent = '‚òÄÔ∏è';
        }
        
        darkModeBtn.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            darkModeBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
        
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });
        
        const modelNames = {
            'gemini': 'Gemini',
            'openai': 'GPT-4o-mini',
            'deepseek': 'DeepSeek'
        };
        
        const contextNames = {
            'casual': 'Tr√≤ chuy·ªán vui v·∫ª',
            'psychological': 'T√¢m l√Ω - T√¢m s·ª±',
            'lifestyle': 'Gi·∫£i ph√°p ƒë·ªùi s·ªëng',
            'programming': 'üíª H·ªó tr·ª£ l·∫≠p tr√¨nh'
        };
        
        function formatTimestamp(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
        
        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });
        
        // Tool buttons
        googleSearchBtn.addEventListener('click', function() {
            toggleTool('google-search', this);
        });
        
        githubBtn.addEventListener('click', function() {
            toggleTool('github', this);
        });
        
        imageGenToolBtn.addEventListener('click', function() {
            toggleTool('image-generation', this);
        });
        
        function toggleTool(tool, btn) {
            if (activeTools.has(tool)) {
                activeTools.delete(tool);
                btn.classList.remove('active');
            } else {
                activeTools.add(tool);
                btn.classList.add('active');
            }
        }
        
        // File upload
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                uploadedFile = this.files[0];
                fileName.textContent = `üìÑ ${uploadedFile.name}`;
            } else {
                uploadedFile = null;
                fileName.textContent = '';
            }
        });
        
        function addMessage(content, isUser, model, context, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const textDiv = document.createElement('div');
            if (isUser) {
                textDiv.textContent = content;
            } else {
                // Parse markdown for assistant messages
                textDiv.innerHTML = marked.parse(content);
                // Highlight code blocks
                textDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                // Add copy button for tables
                textDiv.querySelectorAll('table').forEach((table) => {
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-table-btn';
                    copyBtn.textContent = 'üìã Copy b·∫£ng';
                    copyBtn.onclick = function() {
                        copyTableToClipboard(table, copyBtn);
                    };
                    table.parentNode.insertBefore(copyBtn, table.nextSibling);
                });
            }
            contentDiv.appendChild(textDiv);
            
            if (!isUser && model && context) {
                const infoDiv = document.createElement('div');
                infoDiv.className = 'message-info';
                infoDiv.textContent = `${modelNames[model]} ‚Ä¢ ${contextNames[context]}`;
                contentDiv.appendChild(infoDiv);
            }
            
            // Add timestamp
            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'message-timestamp';
            timestampDiv.textContent = timestamp || formatTimestamp(new Date());
            contentDiv.appendChild(timestampDiv);
            
            // Add copy button for assistant messages
            if (!isUser) {
                const copyMsgBtn = document.createElement('button');
                copyMsgBtn.className = 'copy-message-btn';
                copyMsgBtn.textContent = 'üìã Copy';
                copyMsgBtn.onclick = function() {
                    copyMessageToClipboard(content, copyMsgBtn);
                };
                contentDiv.appendChild(copyMsgBtn);
            }
            
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Save to history
            chatHistory.push({
                content: content,
                isUser: isUser,
                model: model,
                context: context,
                timestamp: timestamp || formatTimestamp(new Date())
            });
            
            // Save to current chat session
            if (currentChatId && chatSessions[currentChatId]) {
                chatSessions[currentChatId].messages = Array.from(chatContainer.children).map(el => el.outerHTML);
                chatSessions[currentChatId].updatedAt = new Date();
                
                // Generate title for first user message
                if (isUser && chatSessions[currentChatId].messages.length === 2 && chatSessions[currentChatId].title === 'Cu·ªôc tr√≤ chuy·ªán m·ªõi') {
                    generateTitle(content).then(title => {
                        chatSessions[currentChatId].title = title;
                        saveSessions();
                        renderChatList();
                    });
                }
                
                saveSessions();
                renderChatList();
            }
        }
        
        function copyMessageToClipboard(content, button) {
            // Copy plain text content
            const plainText = content.replace(/<[^>]*>/g, '').trim();
            
            navigator.clipboard.writeText(plainText).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úÖ ƒê√£ copy!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Kh√¥ng th·ªÉ copy. Vui l√≤ng th·ª≠ l·∫°i!');
            });
        }
        
        function copyTableToClipboard(table, button) {
            // Convert table to TSV (Tab-separated values) for Excel compatibility
            let tsv = '';
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                const rowData = [];
                cells.forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                tsv += rowData.join('\t') + '\n';
            });
            
            // Copy to clipboard
            navigator.clipboard.writeText(tsv).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úÖ ƒê√£ copy!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Kh√¥ng th·ªÉ copy b·∫£ng. Vui l√≤ng th·ª≠ l·∫°i.');
            });
        }
        
        function downloadChat() {
            if (chatHistory.length === 0) {
                alert('Ch∆∞a c√≥ l·ªãch s·ª≠ chat ƒë·ªÉ t·∫£i xu·ªëng!');
                return;
            }
            
            // Create formatted text content
            let content = '='.repeat(60) + '\n';
            content += '  AI CHATBOT - L·ªäCH S·ª¨ H·ªòI THO·∫†I\n';
            content += '  Xu·∫•t l√∫c: ' + new Date().toLocaleString('vi-VN') + '\n';
            content += '='.repeat(60) + '\n\n';
            
            chatHistory.forEach((msg, index) => {
                if (msg.isUser) {
                    content += `[${msg.timestamp}] üë§ USER:\n`;
                    content += msg.content + '\n\n';
                } else {
                    content += `[${msg.timestamp}] ü§ñ ${msg.model ? modelNames[msg.model].toUpperCase() : 'ASSISTANT'}`;
                    if (msg.context) {
                        content += ` (${msg.context})`;
                    }
                    content += ':\n';
                    content += msg.content + '\n\n';
                }
                content += '-'.repeat(60) + '\n\n';
            });
            
            // Create download
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            a.href = url;
            a.download = `chat-history-${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        downloadBtn.addEventListener('click', downloadChat);
        
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            const model = modelSelect.value;
            const context = contextSelect.value;
            const deepThinking = deepThinkingCheck.checked;
            const userTimestamp = formatTimestamp(new Date());
            
            // Check if image generation tool is active
            if (activeTools.has('image-generation')) {
                await handleImageGenerationTool(message, model, context, deepThinking, userTimestamp);
                return;
            }
            
            // Build message with tools
            let fullMessage = message;
            
            // Add deep thinking instruction
            if (deepThinking) {
                fullMessage += '\n\n[Deep Thinking Mode: Please think carefully and provide detailed analysis]';
            }
            
            if (activeTools.size > 0) {
                fullMessage += '\n\n[Tools: ' + Array.from(activeTools).join(', ') + ']';
            }
            if (uploadedFile) {
                fullMessage += `\n\n[File attached: ${uploadedFile.name}]`;
            }
            
            // Add user message
            addMessage(message, true, null, null, userTimestamp);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Show loading
            loading.classList.add('active');
            sendBtn.disabled = true;
            conversationActive = true;
            
            try {
                const startTime = new Date();
                
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: fullMessage,
                        model: model,
                        context: context,
                        deep_thinking: deepThinking,
                        tools: Array.from(activeTools)
                    })
                });
                
                const data = await response.json();
                const responseTimestamp = formatTimestamp(new Date());
                
                if (data.error) {
                    addMessage(`‚ùå **L·ªói:** ${data.error}`, false, model, context, responseTimestamp);
                } else {
                    addMessage(data.response, false, model, context, responseTimestamp);
                }
                
                // If tools were used, keep conversation active
                if (activeTools.size > 0) {
                    addMessage('üí° *Tools ƒëang ho·∫°t ƒë·ªông. Ti·∫øp t·ª•c h·ªôi tho·∫°i ho·∫∑c b·∫•m Cancel ƒë·ªÉ d·ª´ng.*', 
                              false, model, context, formatTimestamp(new Date()));
                }
                
            } catch (error) {
                addMessage(`‚ùå **L·ªói k·∫øt n·ªëi:** ${error.message}`, false, model, context, 
                          formatTimestamp(new Date()));
            } finally {
                loading.classList.remove('active');
                sendBtn.disabled = false;
                messageInput.focus();
                
                // Clear file if not using tools
                if (activeTools.size === 0) {
                    uploadedFile = null;
                    fileInput.value = '';
                    fileName.textContent = '';
                    conversationActive = false;
                }
            }
        }
        
        async function clearHistory() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch s·ª≠ chat hi·ªán t·∫°i?')) return;
            
            try {
                await fetch('/clear', {
                    method: 'POST'
                });
                
                chatContainer.innerHTML = '';
                chatHistory = []; // Clear history array
                
                addMessage('Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI c·ªßa b·∫°n. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay? üòä', 
                          false, 'gemini', 'casual', formatTimestamp(new Date()));
                
                // Reset tools and conversation state
                activeTools.clear();
                googleSearchBtn.classList.remove('active');
                githubBtn.classList.remove('active');
                conversationActive = false;
                
                // Update current session
                if (currentChatId && chatSessions[currentChatId]) {
                    chatSessions[currentChatId].messages = Array.from(chatContainer.children).map(el => el.outerHTML);
                    chatSessions[currentChatId].title = 'Cu·ªôc tr√≤ chuy·ªán m·ªõi';
                    chatSessions[currentChatId].updatedAt = new Date();
                    saveSessions();
                    renderChatList();
                }
                
            } catch (error) {
                alert('L·ªói khi x√≥a l·ªãch s·ª≠: ' + error.message);
            }
        }
        
        sendBtn.addEventListener('click', sendMessage);
        clearBtn.addEventListener('click', clearHistory);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Welcome message removed - chat starts clean
    </script>
    
    <!-- Image Generation Modal -->
    <div id="imageGenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üé® T·∫°o ·∫£nh b·∫±ng AI</h2>
                <button class="close-modal" onclick="closeImageModal()">&times;</button>
            </div>
            
            <div id="sdStatus" class="sd-status offline">
                ƒêang ki·ªÉm tra Stable Diffusion...
            </div>
            
            <div class="form-group">
                <label>Model Checkpoint:</label>
                <select id="modelCheckpoint">
                    <option value="">ƒêang t·∫£i...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Prompt (M√¥ t·∫£ ·∫£nh b·∫°n mu·ªën t·∫°o):</label>
                <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                    <button onclick="randomPrompt()" style="padding: 5px 15px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üé≤ Random</button>
                </div>
                <textarea id="imagePrompt" rows="4" placeholder="1girl, beautiful, detailed face, long hair, cherry blossoms, sunset, masterpiece, best quality"></textarea>
            </div>
            
            <div class="form-group">
                <label>Negative Prompt (Nh·ªØng g√¨ KH√îNG mu·ªën c√≥):</label>
                <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                    <button onclick="randomNegativePrompt()" style="padding: 5px 15px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üé≤ Random</button>
                </div>
                <textarea id="negativePrompt" rows="3" placeholder="bad quality, blurry, distorted, ugly, worst quality"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Width:</label>
                    <select id="imageWidth">
                        <option value="512" selected>512</option>
                        <option value="768">768</option>
                        <option value="1024">1024</option>
                        <option value="1280">1280</option>
                        <option value="1440">1440 (HD)</option>
                        <option value="1920">1920 (FHD)</option>
                        <option value="2560">2560 (4K HD)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Height:</label>
                    <select id="imageHeight">
                        <option value="512" selected>512</option>
                        <option value="768">768</option>
                        <option value="1024">1024</option>
                        <option value="1280">1280</option>
                        <option value="1440">1440 (HD)</option>
                        <option value="1920">1920 (FHD)</option>
                        <option value="2560">2560 (4K HD)</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Steps <span id="stepsLabel">(20-50 khuy·∫øn ngh·ªã)</span>:</label>
                    <input type="number" id="imageSteps" value="20" min="1" max="150">
                </div>
                
                <div class="form-group">
                    <label>CFG Scale <span id="cfgLabel">(7-12 khuy·∫øn ngh·ªã)</span>:</label>
                    <input type="number" id="cfgScale" value="7" min="1" max="30" step="0.5">
                </div>
            </div>
            
            <div class="form-group">
                <label>Sampler:</label>
                <select id="samplerSelect">
                    <option value="DPM++ 2M Karras" selected>DPM++ 2M Karras</option>
                    <option value="Euler a">Euler a</option>
                    <option value="Euler">Euler</option>
                    <option value="DDIM">DDIM</option>
                    <option value="DPM++ SDE Karras">DPM++ SDE Karras</option>
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="restoreFaces">
                        Restore Faces (GFPGAN)
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableHR">
                        Hires. Fix (Ch·∫•t l∆∞·ª£ng cao)
                    </label>
                </div>
            </div>
            
            <button class="generate-btn" id="generateImageBtn" onclick="generateImage()">
                üé® T·∫°o ·∫£nh
            </button>
            
            <div id="generatedImageContainer" style="display: none;">
                <img id="generatedImage" class="generated-image" alt="Generated Image">
                <div class="image-actions">
                    <button class="copy-to-chat-btn" onclick="copyImageToChat()">
                        üí¨ G·ª≠i v√†o Chat
                    </button>
                    <button class="download-image-btn" onclick="downloadGeneratedImage()">
                        üì• T·∫£i xu·ªëng
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Image Generation Functions
        let currentGeneratedImage = null;
        let sdModels = [];
        
        async function openImageModal() {
            const modal = document.getElementById('imageGenModal');
            modal.classList.add('active');
            
            // Check SD status
            await checkSDStatus();
            
            // Load models
            await loadSDModels();
            
            // Load samplers
            await loadSamplers();
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageGenModal');
            modal.classList.remove('active');
        }
        
        async function checkSDStatus() {
            const statusDiv = document.getElementById('sdStatus');
            
            try {
                const response = await fetch('/api/sd-health');
                const data = await response.json();
                
                if (data.status === 'online') {
                    statusDiv.className = 'sd-status online';
                    statusDiv.textContent = `‚úÖ Stable Diffusion ƒëang ch·∫°y | Model: ${data.current_model.model}`;
                } else {
                    statusDiv.className = 'sd-status offline';
                    statusDiv.textContent = `‚ùå ${data.message}. Vui l√≤ng kh·ªüi ƒë·ªông Stable Diffusion WebUI v·ªõi flag --api`;
                }
            } catch (error) {
                statusDiv.className = 'sd-status offline';
                statusDiv.textContent = `‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi Stable Diffusion API`;
            }
        }
        
        async function loadSDModels() {
            const select = document.getElementById('modelCheckpoint');
            
            try {
                const response = await fetch('/api/sd-models');
                const data = await response.json();
                
                sdModels = data.models;
                select.innerHTML = '';
                
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.title;
                    option.textContent = model.model_name;
                    if (model.title === data.current_model) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                // Add change event
                select.addEventListener('change', async (e) => {
                    const selectedModel = e.target.value;
                    if (selectedModel) {
                        await changeSDModel(selectedModel);
                    }
                });
                
            } catch (error) {
                select.innerHTML = '<option>L·ªói khi t·∫£i models</option>';
            }
        }
        
        async function changeSDModel(modelName) {
            try {
                // Show loading state
                const statusDiv = document.querySelector('.sd-status');
                if (statusDiv) {
                    statusDiv.innerHTML = '‚è≥ ƒêang thay ƒë·ªïi model...';
                    statusDiv.style.color = '#ff9800';
                }
                
                const response = await fetch('/api/sd-change-model', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({model_name: modelName})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update status immediately without refresh
                    await checkSDStatus();
                    
                    // Show success message briefly
                    if (statusDiv) {
                        statusDiv.innerHTML = `‚úÖ Model: ${modelName}`;
                        statusDiv.style.color = '#4caf50';
                    }
                }
            } catch (error) {
                console.error('Error changing model:', error);
                const statusDiv = document.querySelector('.sd-status');
                if (statusDiv) {
                    statusDiv.innerHTML = '‚ùå L·ªói thay ƒë·ªïi model';
                    statusDiv.style.color = '#f44336';
                }
            }
        }
        
        function randomPrompt() {
            const prompts = [
                "1girl, beautiful, detailed face, long hair, cherry blossoms, sunset, masterpiece, best quality",
                "anime girl, cyberpunk city, neon lights, rain, futuristic, highly detailed, 4k, best quality",
                "beautiful landscape, mountains, lake, sunrise, dramatic clouds, photorealistic, 8k",
                "fantasy castle, dragons flying, magical atmosphere, epic scene, detailed architecture",
                "cute cat, fluffy, big eyes, sitting on windowsill, sunlight, cozy room, adorable",
                "warrior, armor, sword, battle scene, dramatic lighting, heroic pose, fantasy art",
                "portrait, elegant woman, victorian dress, garden, flowers, soft lighting, painting style",
                "sci-fi spaceship, space station, stars, nebula, futuristic design, detailed interior",
                "underwater scene, coral reef, tropical fish, clear water, sunbeams, vibrant colors",
                "steampunk, mechanical, gears, brass, victorian era, industrial, detailed machinery"
            ];
            
            const randomIndex = Math.floor(Math.random() * prompts.length);
            document.getElementById('imagePrompt').value = prompts[randomIndex];
        }
        
        function randomNegativePrompt() {
            const negativePrompts = [
                "bad quality, blurry, distorted, ugly, worst quality",
                "low quality, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits",
                "worst quality, low quality, normal quality, lowres, low details, oversaturated, undersaturated",
                "cropped, out of frame, blurry, bad art, deformed, poorly drawn, extra limbs, close up",
                "grainy, jpeg artifacts, watermark, signature, username, artist name, logo, text",
                "duplicate, morbid, mutilated, extra fingers, mutated hands, poorly drawn hands, poorly drawn face",
                "ugly, tiling, poorly drawn hands, poorly drawn feet, poorly drawn face, out of frame, mutation",
                "disfigured, deformed, cross-eye, body out of frame, bad anatomy, watermark, grainy, signature"
            ];
            
            const randomIndex = Math.floor(Math.random() * negativePrompts.length);
            document.getElementById('negativePrompt').value = negativePrompts[randomIndex];
        }
        
        // Handle image generation tool
        async function handleImageGenerationTool(userMessage, model, context, deepThinking, userTimestamp) {
            // Add user message to chat
            addMessage(userMessage, true, null, null, userTimestamp);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Show loading
            loading.classList.add('active');
            sendBtn.disabled = true;
            
            try {
                // Step 1: Get AI to generate improved prompt
                addMessage('ü§î ƒêang ph√¢n t√≠ch v√† t·∫°o prompt cho ·∫£nh...', false, model, context, formatTimestamp(new Date()));
                
                let promptInstruction = `Based on this user request: "${userMessage}"

Generate an optimized Stable Diffusion prompt following these rules:
1. Write in English, comma-separated tags
2. Include quality tags: masterpiece, best quality, highly detailed
3. Be descriptive about: subject, style, lighting, composition, colors
4. Keep it concise but detailed (max 100 words)
5. Focus on visual elements only

${deepThinking ? 'Use deep thinking to create the most creative and detailed prompt possible.' : ''}

Return ONLY the prompt, nothing else.`;

                const promptResponse = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: promptInstruction,
                        model: model,
                        context: context,
                        deep_thinking: deepThinking,
                        tools: []
                    })
                });
                
                const promptData = await promptResponse.json();
                const generatedPrompt = promptData.response.trim();
                
                // Show generated prompt
                addMessage(`‚ú® **Prompt ƒë∆∞·ª£c t·∫°o:**\n\`\`\`\n${generatedPrompt}\n\`\`\``, false, model, context, formatTimestamp(new Date()));
                
                // Step 2: Generate negative prompts (random)
                const negativePrompts = [
                    "bad quality, blurry, distorted, ugly, worst quality, r18, nsfw, nude, explicit, sexual",
                    "low quality, bad anatomy, bad hands, r18, nsfw, explicit content, nude, sexual, adult",
                    "worst quality, lowres, r18, nsfw, porn, hentai, explicit, nude, sexual content",
                    "cropped, out of frame, r18, nsfw, nude, sexual, explicit, adult content, porn",
                    "grainy, jpeg artifacts, r18, nsfw, explicit, sexual, nude, adult, porn, hentai"
                ];
                const negativePrompt = negativePrompts[Math.floor(Math.random() * negativePrompts.length)];
                
                // Step 3: Change to AnythingV4 model
                addMessage('‚öôÔ∏è ƒêang chu·∫©n b·ªã model AnythingV4...', false, model, context, formatTimestamp(new Date()));
                
                try {
                    await fetch('/api/sd-change-model', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({model_name: 'AnythingV4_v45.safetensors'})
                    });
                } catch (e) {
                    console.log('Model already set or failed to change:', e);
                }
                
                // Step 4: Generate image with specified parameters
                addMessage('üé® ƒêang t·∫°o ·∫£nh... (c√≥ th·ªÉ m·∫•t 10-30 gi√¢y)', false, model, context, formatTimestamp(new Date()));
                
                const imageParams = {
                    prompt: generatedPrompt,
                    negative_prompt: negativePrompt,
                    width: 1024,
                    height: 1280,
                    steps: 10,
                    cfg_scale: 8,
                    sampler_name: 'DPM++ 2M Karras',
                    seed: -1,
                    restore_faces: false,
                    enable_hr: false
                };
                
                console.log('Generating image with params:', imageParams);
                
                const imageResponse = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(imageParams)
                });
                
                const imageData = await imageResponse.json();
                console.log('Image response:', imageData);
                
                if (imageData.success && imageData.images && imageData.images.length > 0) {
                    // Display image in chat
                    const timestamp = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    const imageHtml = `
                        <div class="message assistant-message">
                            <div class="message-header">
                                <strong>üé® ·∫¢nh ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!</strong>
                                <span class="timestamp">${timestamp}</span>
                            </div>
                            <div class="message-content">
                                <img src="data:image/png;base64,${imageData.images[0]}" alt="Generated Image" style="max-width: 100%; border-radius: 8px; margin: 10px 0;">
                                <div style="margin-top: 10px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-left: 3px solid #4caf50; border-radius: 4px;">
                                    <strong>üìù Prompt:</strong> ${generatedPrompt}<br>
                                    <strong>‚ùå Negative:</strong> ${negativePrompt}<br>
                                    <strong>üñºÔ∏è K√≠ch th∆∞·ªõc:</strong> 1024x1280 | <strong>Steps:</strong> 10 | <strong>CFG:</strong> 8<br>
                                    <strong>üé≤ Sampler:</strong> DPM++ 2M Karras | <strong>ü§ñ Model:</strong> AnythingV4_v45
                                </div>
                            </div>
                        </div>
                    `;
                    
                    const chatMessages = document.getElementById('chatContainer');
                    if (chatMessages) {
                        chatMessages.insertAdjacentHTML('beforeend', imageHtml);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        
                        // Save to current chat session immediately
                        if (currentChatId && chatSessions[currentChatId]) {
                            chatSessions[currentChatId].messages = Array.from(chatMessages.children).map(el => el.outerHTML);
                            chatSessions[currentChatId].updatedAt = new Date();
                            saveSessions();
                        }
                    }
                    
                    // Deactivate tool after successful generation
                    activeTools.delete('image-generation');
                    imageGenToolBtn.classList.remove('active');
                    
                } else {
                    addMessage(`‚ùå **L·ªói t·∫°o ·∫£nh:** ${imageData.error || 'Kh√¥ng r√µ nguy√™n nh√¢n'}`, false, model, context, formatTimestamp(new Date()));
                }
                
            } catch (error) {
                console.error('Error in image generation:', error);
                addMessage(`‚ùå **L·ªói:** ${error.message}`, false, model, context, formatTimestamp(new Date()));
            } finally {
                loading.classList.remove('active');
                sendBtn.disabled = false;
                messageInput.focus();
            }
        }
        
        async function loadSamplers() {
            try {
                const response = await fetch('/api/sd-samplers');
                const data = await response.json();
                
                const select = document.getElementById('samplerSelect');
                select.innerHTML = '';
                
                data.samplers.forEach(sampler => {
                    const option = document.createElement('option');
                    option.value = sampler;
                    option.textContent = sampler;
                    select.appendChild(option);
                });
                
                // Set default
                select.value = 'DPM++ 2M Karras';
                
            } catch (error) {
                console.error('Error loading samplers:', error);
            }
        }
        
        // Auto-adjust steps and CFG based on image size
        function adjustStepsAndCFG() {
            const width = parseInt(document.getElementById('imageWidth').value);
            const height = parseInt(document.getElementById('imageHeight').value);
            const stepsInput = document.getElementById('imageSteps');
            const cfgInput = document.getElementById('cfgScale');
            const stepsLabel = document.getElementById('stepsLabel');
            const cfgLabel = document.getElementById('cfgLabel');
            
            // Calculate max dimension and megapixels
            const maxDim = Math.max(width, height);
            const megapixels = (width * height) / 1_000_000;
            
            // Warning for 4K images
            if (megapixels >= 4) {
                const currentSteps = parseInt(stepsInput.value);
                const estimatedTime = Math.ceil((currentSteps * (2 + megapixels * 1.5)) / 60);
                
                alert(`‚ö†Ô∏è C·∫¢NH B√ÅO 4K:\n\n` +
                      `K√≠ch th∆∞·ªõc ${width}x${height} (${megapixels.toFixed(1)}MP) v·ªõi ${currentSteps} steps\n` +
                      `Th·ªùi gian ∆∞·ªõc t√≠nh: ${estimatedTime} ph√∫t\n\n` +
                      `L∆∞u √Ω:\n` +
                      `- Kh√¥ng c√≥ timeout - s·∫Ω ch·ªù cho ƒë·∫øn khi ho√†n t·∫•t\n` +
                      `- B·∫°n c√≥ th·ªÉ cancel request b·∫±ng c√°ch refresh trang\n` +
                      `- Ho·∫∑c gi·∫£m steps xu·ªëng 30-40 ƒë·ªÉ nhanh h∆°n\n` +
                      `- ƒê·∫£m b·∫£o GPU c√≥ ƒë·ªß VRAM (c·∫ßn ~8GB)`);
            }
            
            // If size >= 1440, enforce minimum steps=50, cfg=12
            if (maxDim >= 1440) {
                // Update minimum values
                const currentSteps = parseInt(stepsInput.value);
                const currentCfg = parseFloat(cfgInput.value);
                
                if (currentSteps < 50) {
                    stepsInput.value = 50;
                }
                if (currentCfg < 12) {
                    cfgInput.value = 12;
                }
                
                // Update labels with time warning
                stepsLabel.textContent = `(T·ªëi thi·ªÉu 50 cho HD/4K - ~${Math.ceil(megapixels * 2)}min)`;
                stepsLabel.style.color = '#ff9800';
                cfgLabel.textContent = '(T·ªëi thi·ªÉu 12 cho HD/4K)';
                cfgLabel.style.color = '#ff9800';
                
                // Set minimum attributes
                stepsInput.min = 50;
                cfgInput.min = 12;
            } else {
                // Reset to default for smaller sizes
                stepsLabel.textContent = '(20-50 khuy·∫øn ngh·ªã)';
                stepsLabel.style.color = '';
                cfgLabel.textContent = '(7-12 khuy·∫øn ngh·ªã)';
                cfgLabel.style.color = '';
                
                stepsInput.min = 1;
                cfgInput.min = 1;
            }
        }
        
        async function generateImage() {
            const btn = document.getElementById('generateImageBtn');
            const container = document.getElementById('generatedImageContainer');
            
            console.log('generateImage called');
            
            // Get form values
            const params = {
                prompt: document.getElementById('imagePrompt').value,
                negative_prompt: document.getElementById('negativePrompt').value,
                width: parseInt(document.getElementById('imageWidth').value),
                height: parseInt(document.getElementById('imageHeight').value),
                steps: parseInt(document.getElementById('imageSteps').value),
                cfg_scale: parseFloat(document.getElementById('cfgScale').value),
                sampler_name: document.getElementById('samplerSelect').value,
                restore_faces: document.getElementById('restoreFaces').checked,
                enable_hr: document.getElementById('enableHR').checked,
                seed: -1
            };
            
            console.log('Params:', params);
            
            if (!params.prompt) {
                alert('Vui l√≤ng nh·∫≠p prompt!');
                return;
            }
            
            // Disable button and show loading
            btn.disabled = true;
            btn.textContent = '‚è≥ ƒêang t·∫°o ·∫£nh...';
            container.style.display = 'none';
            
            try {
                console.log('Sending request to /api/generate-image');
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success && data.images && data.images.length > 0) {
                    // Display image
                    currentGeneratedImage = data.images[0];
                    const img = document.getElementById('generatedImage');
                    img.src = 'data:image/png;base64,' + currentGeneratedImage;
                    container.style.display = 'block';
                    
                    // Auto-add to chat conversation
                    const timestamp = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    const imageHtml = `
                        <div class="message assistant-message">
                            <div class="message-header">
                                <strong>üé® ·∫¢nh ƒë∆∞·ª£c t·∫°o</strong>
                                <span class="timestamp">${timestamp}</span>
                            </div>
                            <div class="message-content">
                                <img src="data:image/png;base64,${currentGeneratedImage}" alt="Generated Image" style="max-width: 100%; border-radius: 8px; margin: 10px 0;">
                                <div style="margin-top: 10px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-left: 3px solid #4caf50; border-radius: 4px;">
                                    <strong>Prompt:</strong> ${params.prompt}<br>
                                    ${params.negative_prompt ? `<strong>Negative:</strong> ${params.negative_prompt}<br>` : ''}
                                    <strong>Model:</strong> ${params.model || 'Default'}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add to chat - use correct element ID
                    const chatMessages = document.getElementById('chatContainer');
                    if (chatMessages) {
                        chatMessages.insertAdjacentHTML('beforeend', imageHtml);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        
                        // Save to current chat session immediately
                        if (currentChatId && chatSessions[currentChatId]) {
                            chatSessions[currentChatId].messages = Array.from(chatMessages.children).map(el => el.outerHTML);
                            chatSessions[currentChatId].updatedAt = new Date();
                            saveSessions();
                        }
                    }
                    
                    btn.textContent = '‚úÖ ·∫¢nh ƒë√£ t·∫°o xong!';
                    setTimeout(() => {
                        btn.textContent = 'üé® T·∫°o ·∫£nh';
                    }, 2000);
                } else {
                    console.error('Failed to generate image:', data);
                    alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫°o ·∫£nh'));
                    btn.textContent = 'üé® T·∫°o ·∫£nh';
                }
                
            } catch (error) {
                console.error('Error generating image:', error);
                alert('L·ªói khi t·∫°o ·∫£nh: ' + error.message);
                btn.textContent = 'üé® T·∫°o ·∫£nh';
            } finally {
                console.log('Re-enabling button');
                btn.disabled = false;
            }
        }
        
        function copyImageToChat() {
            if (!currentGeneratedImage) return;
            
            // Add image to chat
            const timestamp = formatTimestamp(new Date());
            const imageHtml = `<img src="data:image/png;base64,${currentGeneratedImage}" style="max-width: 400px; border-radius: 10px; margin-top: 10px;">`;
            
            addMessage(imageHtml, false, 'stable-diffusion', 'image-generation', timestamp);
            
            // Close modal
            closeImageModal();
            
            // Show success message
            alert('·∫¢nh ƒë√£ ƒë∆∞·ª£c th√™m v√†o chat! üé®');
        }
        
        function downloadGeneratedImage() {
            if (!currentGeneratedImage) return;
            
            const link = document.createElement('a');
            link.href = 'data:image/png;base64,' + currentGeneratedImage;
            link.download = `ai-generated-${Date.now()}.png`;
            link.click();
        }
        
        // Add event listener for image gen button
        document.getElementById('imageGenBtn').addEventListener('click', openImageModal);
        
        // Add event listeners for width/height to auto-adjust steps and CFG
        document.getElementById('imageWidth').addEventListener('change', adjustStepsAndCFG);
        document.getElementById('imageHeight').addEventListener('change', adjustStepsAndCFG);
        
        // Add event listener for model select to auto-update
        if (modelSelect) {
            modelSelect.addEventListener('change', async (e) => {
                const selectedModel = e.target.value;
                if (selectedModel) {
                    await changeSDModel(selectedModel);
                }
            });
        }
        
        // Close modal when clicking outside
        document.getElementById('imageGenModal').addEventListener('click', (e) => {
            if (e.target.id === 'imageGenModal') {
                closeImageModal();
            }
        });
    </script>
</body>
</html>
